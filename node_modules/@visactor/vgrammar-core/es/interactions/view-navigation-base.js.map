{"version":3,"sources":["../src/interactions/view-navigation-base.ts"],"names":[],"mappings":"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","file":"view-navigation-base.js","sourcesContent":["import { isNil, isString } from '@visactor/vutils';\nimport type {\n  FilterDataTarget,\n  IBaseInteractionOptions,\n  IComponent,\n  IDataFilter,\n  IDatazoom,\n  IMark,\n  IScale,\n  IScrollbar,\n  IView,\n  InteractionEvent,\n  ViewNavigationBaseOptions,\n  ViewNavigationRange,\n  ViewStateByDim\n} from '../types';\nimport { BaseInteraction } from './base';\nimport { ComponentEnum, DataFilterRank, GrammarMarkType } from '../graph/enums';\nimport { getScaleRangeRatio } from '../util/scale';\n\nexport abstract class ViewNavigationBase<\n  T extends ViewNavigationBaseOptions & IBaseInteractionOptions\n> extends BaseInteraction<T> {\n  options: T;\n\n  protected _state: Partial<Record<'x' | 'y', ViewStateByDim>>;\n  protected _inited?: boolean;\n  protected _dataFilterX: IDataFilter;\n  protected _dataFilterY: IDataFilter;\n\n  constructor(view: IView, options?: T) {\n    super(view, options);\n    this.options = options;\n  }\n\n  protected _parseLinkedComponent(option: string | IDatazoom | IScrollbar): IDatazoom | IScrollbar {\n    if (!option) {\n      return null;\n    }\n    const comp: IMark = isString(option) ? this.view.getMarkById(option) : option;\n\n    if (\n      comp &&\n      comp.markType === GrammarMarkType.component &&\n      ((comp as IComponent).componentType === ComponentEnum.datazoom ||\n        (comp as IComponent).componentType === ComponentEnum.scrollbar)\n    ) {\n      return comp as IDatazoom | IScrollbar;\n    }\n\n    return null;\n  }\n\n  protected _initStateByDim(\n    dim: 'x' | 'y',\n    linkedComponent?: string | IDatazoom | IScrollbar,\n    scale?: string | IScale,\n    dataTarget?: FilterDataTarget\n  ) {\n    const comp = this._parseLinkedComponent(linkedComponent);\n\n    if (comp) {\n      this._state[dim] = { linkedComponent: comp };\n      return;\n    }\n\n    const scaleGrammar = !isNil(scale) ? (isString(scale) ? this.view.getScaleById(scale) : scale) : null;\n    const dataGrammar = !isNil(dataTarget?.data)\n      ? isString(dataTarget.data)\n        ? this.view.getDataById(dataTarget.data)\n        : dataTarget.data\n      : null;\n\n    if (!scaleGrammar || !dataGrammar) {\n      this._state[dim] = { data: dataGrammar, scale: scaleGrammar };\n      return;\n    }\n\n    dataGrammar.attach(scaleGrammar);\n\n    const filterByScale = isString(dataTarget.filter)\n      ? (datum: any, filterValue: number[]) => {\n          const scale = scaleGrammar.getScale();\n          const ratio = getScaleRangeRatio(scale, datum[dataTarget.filter as string]);\n\n          return ratio >= filterValue[0] && ratio <= filterValue[1];\n        }\n      : dataTarget.filter;\n    const dataFilter = {\n      source: `${scaleGrammar.uid}`,\n      rank: DataFilterRank.normal,\n      filter: (data: any[]) => {\n        const filterValue = dim === 'x' ? this._state?.x?.filterValue : this._state?.y?.filterValue;\n        if (!filterValue) {\n          return data;\n        }\n        const filteredData = data.filter(datum => filterByScale(datum, filterValue));\n        return dataTarget.transform ? dataTarget.transform(filteredData, filterValue) : filteredData;\n      }\n    };\n\n    if (dim === 'x') {\n      this._dataFilterX = dataFilter;\n    } else {\n      this._dataFilterY = dataFilter;\n    }\n\n    dataGrammar.addDataFilter(dataFilter);\n\n    this._state[dim] = { data: dataGrammar, scale: scaleGrammar };\n  }\n\n  protected _initGrammars() {\n    const { enableX, enableY, scaleX, scaleY, dataTargetX, dataTargetY, linkedComponentX, linkedComponentY } =\n      this.options;\n\n    this._state = {};\n\n    if (enableX !== false) {\n      this._initStateByDim('x', linkedComponentX, scaleX, dataTargetX);\n    }\n\n    if (enableY !== false) {\n      this._initStateByDim('y', linkedComponentY, scaleY, dataTargetY);\n    }\n\n    this._inited = true;\n  }\n\n  protected _updateLinkedComponent(comp: IDatazoom | IScrollbar, newRange: [number, number]) {\n    if (comp.componentType === ComponentEnum.datazoom) {\n      (comp as IDatazoom).setStartEndValue(newRange[0], newRange[1]);\n    } else {\n      // fix: need to update range scrollbar\n      (comp as IScrollbar).setScrollStart(newRange[0]);\n    }\n  }\n\n  updateView(type: 'start' | 'reset' | 'update' | 'end', newRange: ViewNavigationRange, e?: InteractionEvent) {\n    if (newRange && newRange.x && this._state?.x?.linkedComponent) {\n      this._updateLinkedComponent(this._state.x.linkedComponent, newRange.x);\n    }\n\n    if (newRange && newRange.y && this._state?.y?.linkedComponent) {\n      this._updateLinkedComponent(this._state.y.linkedComponent, newRange.y);\n    }\n\n    if (newRange && newRange.needUpdate) {\n      this.view.runAsync();\n    }\n\n    this.dispatchEvent(type, { viewRange: newRange, event: e });\n  }\n\n  unbind() {\n    super.unbind();\n\n    if (this._state) {\n      Object.keys(this._state).forEach(dim => {\n        const { data, scale } = this._state[dim as 'x' | 'y'];\n\n        if (data && scale) {\n          data.detach(scale);\n          data.removeDataFilter(dim === 'x' ? this._dataFilterX : this._dataFilterY);\n        } else if (scale) {\n          scale.setRangeFactor(null);\n          scale.commit();\n        }\n      });\n    }\n\n    this._state = null;\n  }\n}\n"]}