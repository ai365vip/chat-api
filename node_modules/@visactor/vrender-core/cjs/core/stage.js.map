{"version":3,"sources":["../src/core/stage.ts"],"names":[],"mappings":";;;AACA,6CAAuE;AA0BvE,qCAAmC;AAEnC,oCAAuC;AACvC,4CAAyC;AACzC,sCAA0C;AAC1C,wCAA0C;AAC1C,mDAAoD;AACpD,oDAAqD;AACrD,qFAAgF;AAChF,gGAA0F;AAC1F,6GAAuG;AACvG,2FAAsF;AACtF,uFAAkF;AAClF,qFAAgF;AAChF,8DAA0D;AAC1D,wCAAsC;AACtC,mCAA2C;AAC3C,qCAAuC;AACvC,2CAA2C;AAC3C,wCAA6C;AAC7C,gDAA6C;AAC7C,4CAA4C;AAE5C,MAAM,aAAa,GAAG;IACpB,KAAK,EAAE,GAAG;IACV,MAAM,EAAE,GAAG;IACX,CAAC,EAAE,CAAC;IACJ,CAAC,EAAE,CAAC;IACJ,UAAU,EAAE,OAAO;CACpB,CAAC;AAeF,MAAa,KAAM,SAAQ,eAAK;IAuB9B,IAAI,OAAO,CAAC,CAAc;QACxB,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;IACjD,CAAC;IACD,IAAI,OAAO;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC;IACvB,CAAC;IAED,IAAI,CAAC;QACH,OAAO,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC;IAC1B,CAAC;IACD,IAAI,CAAC,CAAC,CAAS;QACb,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;IACnD,CAAC;IACD,IAAI,CAAC;QACH,OAAO,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC;IAC1B,CAAC;IACD,IAAI,CAAC,CAAC,CAAS;QACb,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IACnD,CAAC;IACD,IAAI,KAAK;QACP,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC;IAC3B,CAAC;IACD,IAAI,KAAK,CAAC,CAAS;QACjB,IAAI,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;IAC9B,CAAC;IACD,IAAI,SAAS;QACX,OAAO,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;IAC/B,CAAC;IACD,IAAI,SAAS,CAAC,CAAS;QACrB,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;IACtC,CAAC;IACD,IAAI,UAAU;QACZ,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;IAChC,CAAC;IACD,IAAI,UAAU,CAAC,CAAS;QACtB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC;IACrC,CAAC;IACD,IAAI,MAAM;QACR,OAAO,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC;IAC5B,CAAC;IACD,IAAI,MAAM,CAAC,CAAS;QAClB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;IAC7B,CAAC;IACD,IAAI,GAAG;QACL,OAAO,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC;IACzB,CAAC;IACD,IAAI,GAAG,CAAC,CAAS;QACf,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;IACjB,CAAC;IACD,IAAI,UAAU;;QACZ,OAAO,MAAA,IAAI,CAAC,WAAW,mCAAI,aAAa,CAAC,UAAU,CAAC;IACtD,CAAC;IACD,IAAI,UAAU,CAAC,CAAkB;QAC/B,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;IACvB,CAAC;IACD,IAAI,YAAY;QACd,OAAO,IAAI,CAAC,EAAE,CAAC,CAAC,CAAsB,CAAC;IACzC,CAAC;IAgBD,IAAY,WAAW;QACrB,OAAO,IAAI,CAAC,YAAY,CAAC;IAC3B,CAAC;IAsBD,YAAY,SAAgC,EAAE;;QAC5C,KAAK,CAAC,EAAE,CAAC,CAAC;QAqJF,qBAAgB,GAAG,CAAC,OAAgB,EAAE,EAAE;YAChD,IAAI,IAAI,CAAC,WAAW,GAAG,CAAC,EAAE;gBACxB,OAAO;aACR;YACD,IAAI,OAAO,EAAE;gBACX,IAAI,IAAI,CAAC,WAAW,EAAE;oBACpB,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,EAAE,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC;iBAChF;gBACD,IAAI,IAAI,CAAC,WAAW,GAAG,CAAC,EAAE;oBACxB,IAAI,CAAC,eAAe,EAAE,CAAC;iBACxB;gBACD,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;aACtB;iBAAM;gBACL,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;aACtB;QACH,CAAC,CAAC;QA0EQ,iBAAY,GAAG,CAAC,KAAa,EAAE,EAAE;YACzC,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAClD,CAAC,CAAC;QAEQ,gBAAW,GAAG,CAAC,KAAa,EAAE,EAAE;YACxC,IAAI,CAAC,WAAW,EAAE,CAAC;YACnB,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;YAC9C,IAAI,CAAC,mBAAmB,IAAI,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC;YAC9E,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC;QAClC,CAAC,CAAC;QAtPA,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,KAAK,GAAG,IAAI,eAAK,EAAE,CAAC;QACzB,IAAI,CAAC,KAAK,GAAG;YACX,YAAY,EAAE,IAAI,kBAAQ,CAAC,CAAC,OAAO,CAAC,CAAC;YACrC,WAAW,EAAE,IAAI,kBAAQ,CAAC,CAAC,OAAO,CAAC,CAAC;SACrC,CAAC;QACF,IAAI,CAAC,MAAM,GAAG,yBAAW,CAAC,MAAM,CAAC;QACjC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,IAAI,IAAA,wBAAY,GAAE,EAAE;YAEtC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;SAC/B;QACD,IAAI,CAAC,MAAM,GAAG,qBAAS,CAAC,GAAG,CAAU,gBAAO,CAAC,CAAC;QAC9C,IAAI,CAAC,aAAa,GAAG,qBAAS,CAAC,GAAG,CAAiB,sBAAa,CAAC,CAAC;QAClE,IAAI,CAAC,aAAa,GAAG,qBAAS,CAAC,GAAG,CAAiB,yBAAa,CAAC,CAAC;QAClE,IAAI,CAAC,YAAY,GAAG,qBAAS,CAAC,GAAG,CAAgB,wBAAY,CAAC,CAAC;QAC/D,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QAExC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC;YACjB,KAAK,EAAE,MAAM,CAAC,KAAK;YACnB,MAAM,EAAE,MAAM,CAAC,MAAM;YACrB,SAAS,EAAE,MAAM,CAAC,SAAS;YAC3B,GAAG,EAAE,MAAM,CAAC,GAAG,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB;YAC/C,eAAe,EAAE,MAAM,CAAC,eAAe,KAAK,KAAK;YACjD,KAAK,EAAE,MAAM,CAAC,KAAK,IAAI,EAAE;YACzB,MAAM,EAAE,MAAM,CAAC,MAAM;SACtB,CAAC,CAAC;QAEH,IAAI,CAAC,QAAQ,GAAG,IAAI,mBAAU,EAAE,CAAC;QACjC,IAAI,MAAM,CAAC,OAAO,EAAE;YAClB,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,EAAE,MAAM,CAAC,OAAO,CAAC,EAAE,EAAE,MAAM,CAAC,OAAO,CAAC,EAAE,EAAE,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;SACpG;aAAM;YACL,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;SACvD;QAED,IAAI,CAAC,KAAK,GAAG,QAAQ,CAAC;QACtB,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;QACrB,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAO1B,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,KAAK,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,KAAK,IAAI,CAAC,MAAM,CAAC,CAAC;QAGlG,IAAI,CAAC,WAAW,GAAG,MAAA,MAAM,CAAC,UAAU,mCAAI,aAAa,CAAC,UAAU,CAAC;QAIjE,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,IAAI,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC;QAEtE,IAAI,CAAC,uBAAuB,GAAG,IAAI,GAAG,EAAE,CAAC;QACzC,IAAI,CAAC,mBAAmB,GAAG,KAAK,CAAC;QACjC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAClB,IAAI,CAAC,WAAW,GAAG,MAAM,CAAC,WAAW,CAAC;QAGtC,IAAI,MAAM,CAAC,UAAU,EAAE;YACrB,IAAI,CAAC,gBAAgB,EAAE,CAAC;SACzB;QAED,IAAI,MAAM,CAAC,kBAAkB,KAAK,KAAK,EAAE;YACvC,IAAI,CAAC,iBAAiB,EAAE,CAAC;SAC1B;QAED,IAAI,MAAM,CAAC,mBAAmB,EAAE;YAC9B,IAAI,CAAC,mBAAmB,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;SACtD;QAED,MAAM,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;QAC3C,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,GAAG,CAAC,aAAa,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;QAC9D,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,GAAG,CAAC,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;QAC5D,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,YAAY,GAAG,MAAM,CAAC,WAAW,CAAC;QACvC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC,MAAM,IAAI,8BAAa,CAAC;QAC7C,IAAI,CAAC,uBAAuB,GAAG,MAAM,CAAC,gBAAgB,KAAK,KAAK,CAAC;QACjE,IAAI,CAAC,QAAQ,GAAG,IAAI,yBAAe,EAAE,CAAC;QACtC,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACvC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;QACtB,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE;YACpB,MAAM,CAAC,QAAQ,GAAG,EAAE,CAAC;SACtB;QACD,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAE9B,IAAI,MAAM,CAAC,UAAU,IAAI,IAAA,iBAAQ,EAAC,IAAI,CAAC,WAAW,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;YACrF,IAAI,CAAC,aAAa,CAAC,EAAE,UAAU,EAAE,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC;SACtD;IACH,CAAC;IAES,kBAAkB;QAC1B,IAAI,IAAI,CAAC,MAAM,CAAC,YAAY,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE;YAClD,IAAI,CAAC,YAAY,GAAG,IAAI,mBAAW,iBACjC,aAAa,EAAE,IAAI,CAAC,MAAM,EAC1B,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAC3D,QAAQ,EAAE,IAAW,EACrB,MAAM,EAAE,IAAI,CAAC,MAAM,EACnB,qBAAqB,EAAE,IAAI,CAAC,MAAM,CAAC,qBAAqB,EACxD,mBAAmB,EAAE,IAAI,CAAC,MAAM,CAAC,mBAAmB,EACpD,QAAQ,EAAE;oBACR,OAAO,EAAE,IAAI,CAAC,QAAQ;oBACtB,IAAI,CAAC;wBACH,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;oBACzB,CAAC;oBACD,IAAI,CAAC;wBACH,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;oBACzB,CAAC;oBACD,IAAI,KAAK;wBACP,OAAO,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;oBAC9B,CAAC;oBACD,IAAI,MAAM;wBACR,OAAO,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC;oBAC/B,CAAC;iBACF,IACE,IAAI,CAAC,MAAM,CAAC,KAAK,EACpB,CAAC;SACJ;IACH,CAAC;IAED,aAAa,CAAC,OAAgB;QAC5B,IAAI,OAAO,EAAE;YACX,IAAI,CAAC,WAAW,GAAG,CAAC,QAAQ,CAAC;SAC9B;aAAM;YAEL,IAAI,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,sBAAsB,KAAK,KAAK,EAAE;gBACzD,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;aACpD;iBAAM;gBACL,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;aACtB;SACF;IACH,CAAC;IAGD,OAAO,CAAC,MAAqB;QAC3B,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,sBAAsB,CAAC,CAAC;QAClD,IAAI,CAAC,MAAM,CAAC,QAAQ,GAAG,MAAM,CAAC;IAChC,CAAC;IAGS,aAAa,CAAC,yBAAkC,KAAK;QAC7D,IAAI,CAAC,sBAAsB,EAAE;YAC3B,OAAO;SACR;QAED,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC7F,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;IACrD,CAAC;IAmBD,WAAW;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC;IACvB,CAAC;IAED,YAAY,CAAC,OAAkB;QAC7B,MAAM,EACJ,MAAM,GAAG,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK,GAAG,CAAC,EAAE,CAAC,EAAE,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAC7E,KAAK,GAAG,EAAE,EACV,KAAK,GAAG,CAAC,EACT,IAAI,GAAG,CAAC,EACR,MAAM,EACN,UAAU,GAAG,CAAC,EACd,UAAU,EACX,GAAG,OAAO,CAAC;QAEZ,uCACK,OAAO,KACV,MAAM;YACN,KAAK;YACL,KAAK;YACL,IAAI;YACJ,MAAM;YACN,UAAU;YACV,UAAU,IACV;IACJ,CAAC;IAED,YAAY,CAAC,OAAkB;;QAC7B,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,MAAM,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAC7C,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,SAAS,CAAC;QACjF,MAAM,EAAE,GAAG,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,KAAK,GAAG,OAAO,EAAE,OAAO,EAAE,GAAG,KAAK,CAAC;QAE7D,MAAM,OAAO,GAAG,CAAC,MAAA,MAAM,CAAC,CAAC,mCAAI,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC,GAAG,CAAC,MAAA,MAAM,CAAC,EAAE,mCAAI,CAAC,CAAC,CAAC;QAChE,MAAM,OAAO,GAAG,CAAC,MAAA,MAAM,CAAC,CAAC,mCAAI,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,MAAA,MAAM,CAAC,EAAE,mCAAI,CAAC,CAAC,CAAC;QACjE,MAAM,OAAO,GAAG,CAAC,MAAA,MAAM,CAAC,CAAC,mCAAI,CAAC,CAAC,GAAG,CAAC,MAAA,MAAM,CAAC,EAAE,mCAAI,CAAC,CAAC,CAAC;QACnD,MAAM,UAAU,GAAS,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;QACrD,MAAM,CAAC,GAAG,CAAC,CAAC;QACZ,IAAI,OAAO,GAAG,CAAC,CAAC;QAChB,IAAI,OAAO,GAAG,CAAC,CAAC;QAChB,IAAI,OAAO,GAAG,CAAC,CAAC;QAChB,IAAI,CAAC,MAAM,EAAE;YACX,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,OAAO,CAAC;YACpC,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,OAAO,CAAC;YACnC,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;SAChD;QAED,IAAI,CAAC,KAAK,GAAG,IAAI,wBAAgB,CAAC,GAAG,EAAE,KAAK,EAAE,OAAO,CAAC,CAAC;QACvD,MAAM,YAAY,GAAG;YACnB,IAAI,EAAE,CAAC;YACP,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,GAAG,EAAE,CAAC;YACN,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,UAAU,EAAE,UAAU;YACtB,UAAU;YACV,UAAU,EAAE;gBACV,GAAG,EAAE,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAS;gBACxC,MAAM,EAAE,UAAU;gBAClB,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAS;aACtB;SACF,CAAC;QACF,IAAI,IAAI,CAAC,MAAM,EAAE;YACf,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,YAAY,CAAC;SACnC;aAAM;YACL,IAAI,CAAC,MAAM,GAAG,IAAI,oBAAW,CAAC,YAAY,CAAC,CAAC;SAC7C;QAED,IAAI,OAAO,CAAC,qBAAqB,EAAE;YACjC,IAAI,CAAC,qBAAqB,EAAE,CAAC;SAC9B;IACH,CAAC;IAaD,eAAe,CAAC,EAA2B;QACzC,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;IAC1B,CAAC;IAED,cAAc,CAAC,EAA2B;QACxC,IAAI,CAAC,YAAY,GAAG,EAAE,CAAC;IACzB,CAAC;IAED,eAAe,CAAC,EAA2B;QACzC,IAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE;YAC7B,IAAI,CAAC,mBAAmB,GAAG,EAAE,CAAC;SAC/B;QACD,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;IACpC,CAAC;IAED,qBAAqB;QACnB,IAAI,IAAI,CAAC,cAAc,EAAE;YACvB,OAAO;SACR;QACD,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC;QAC3B,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,IAAI,gDAAqB,EAAE,CAAC,CAAC;IAC3D,CAAC;IAED,qBAAqB;QACnB,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE;YACxB,OAAO;SACR;QACD,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC;QAC5B,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,uBAAuB,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YAC7E,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IAED,gBAAgB;QACd,IAAI,IAAI,CAAC,UAAU,EAAE;YACnB,OAAO;SACR;QACD,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QACvB,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,IAAI,qCAAgB,EAAE,CAAC,CAAC;IACtD,CAAC;IACD,iBAAiB;QACf,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE;YACpB,OAAO;SACR;QACD,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;QACxB,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YACxE,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IACD,2BAA2B;QACzB,IAAI,IAAI,CAAC,kBAAkB,EAAE;YAC3B,OAAO;SACR;QACD,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;QAC/B,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,IAAI,4DAA2B,EAAE,CAAC,CAAC;IACjE,CAAC;IACD,4BAA4B;QAC1B,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE;YAC5B,OAAO;SACR;QACD,IAAI,CAAC,kBAAkB,GAAG,KAAK,CAAC;QAChC,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,6BAA6B,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YACnF,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IACD,iBAAiB;QACf,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,OAAO;SACR;QACD,IAAI,CAAC,WAAW,GAAG,IAAI,eAAM,EAAE,CAAC;QAChC,IAAI,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC,CAAC;QAC1E,IAAI,CAAC,MAAM,EAAE;YACX,MAAM,GAAG,IAAI,uCAAiB,EAAE,CAAC;YACjC,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;SACrC;aAAM;YACL,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;SACrC;IACH,CAAC;IACD,kBAAkB;QAChB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YACrB,OAAO;SACR;QACD,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;QACxB,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,mBAAmB,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YACzE,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IACD,YAAY;QACV,IAAI,IAAI,CAAC,aAAa,EAAE;YACtB,OAAO;SACR;QACD,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;QAC1B,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,IAAI,qCAAgB,EAAE,CAAC,CAAC;IACtD,CAAC;IACD,aAAa;QACX,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACvB,OAAO;SACR;QACD,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC;QAC3B,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YACxE,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IACD,mBAAmB,CAAC,SAAe;QACjC,IAAI,IAAI,CAAC,aAAa,EAAE;YACtB,OAAO;SACR;QACD,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;QAC/B,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,IAAI,2CAAmB,EAAE,CAAC,CAAC;IACzD,CAAC;IACD,oBAAoB;QAClB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACvB,OAAO;SACR;QACD,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC;QAC3B,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,qBAAqB,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YAC3E,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;IACL,CAAC;IAeS,mBAAmB;QAC3B,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC;QAC9B,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,EAAE,OAAO,CAAC,EAAE,EAAE,OAAO,CAAC,EAAE,EAAE,OAAO,CAAC,EAAE,CAAC,CAAC;QAC1E,OAAO,IAAI,CAAC,WAAW,CAAC;IAC1B,CAAC;IAED,YAAY,CAAC,OAAe,EAAE,OAAe;QAC3C,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC;IAC1B,CAAC;IAGD,WAAW,CAAC,QAAiB,EAAE,SAAqB;QAElD,MAAM,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,IAAI,EAAE;YAChD,IAAI,EAAE,KAAK;YACX,SAAS;YACT,QAAQ;SACT,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACxB,OAAO,KAAK,CAAC;IAOf,CAAC;IACD,SAAS,CAAC,EAA+C;QACvD,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;QAC/B,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QAClB,IAAI,CAAC,cAAc,EAAE,CAAC;QACtB,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;YACnB,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;QACtB,CAAC,CAAC,CAAC;IACL,CAAC;IACD,WAAW,CAAC,QAAgB;QAC1B,OAAO,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAa,CAAW,CAAC;IAC/E,CAAC;IACD,uBAAuB;QAGrB,IAAI,IAAI,CAAC,uBAAuB,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE;YAC1D,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;YAC3C,IAAI,CAAC,gBAAgB,CAAC,IAAI,GAAG,sBAAsB,CAAC;YACpD,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,QAAQ,GAAG,KAAK,CAAC;YACjD,IAAI,CAAC,uBAAuB,CAAC,GAAG,CAAC,IAAI,CAAC,gBAAuB,CAAC,CAAC;SAChE;IAIH,CAAC;IAED,YAAY,CAAC,KAAc;QACzB,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;IACjD,CAAC;IAED,MAAM,CAAC,MAAiB,EAAE,MAA8B;QACtD,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;QACpB,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;QACvB,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QACzB,IAAI,CAAC,KAAK,GAAG,WAAW,CAAC;QACzB,IAAI,CAAC,YAAY,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC1C,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YACrB,IAAI,CAAC,gBAAgB,GAAG,MAAM,CAAC;YAC/B,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACnC,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,QAAoB,CAAC,CAAC;YAChD,IAAI,CAAC,qBAAqB,EAAE,CAAC;YAC7B,IAAI,CAAC,uBAAuB,CAAC,KAAK,EAAE,CAAC;YACrC,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SACnC;QACD,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;IACzC,CAAC;IAES,qBAAqB;QAC7B,OAAO;IAaT,CAAC;IAED,eAAe,CAAC,MAAiB,EAAE,KAAe;QAOhD,IAAI,IAAI,CAAC,uBAAuB,CAAC,IAAI,KAAK,IAAI,CAAC,aAAa,EAAE;YAC5D,CAAC,MAAM,IAAI,IAAI,CAAC,CAAC,OAAO,CAAS,CAAC,KAAU,EAAE,EAAE;gBAC9C,IAAI,CAAC,uBAAuB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YAC1C,CAAC,CAAC,CAAC;SACJ;QACD,IAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE;YAC7B,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC;YAChC,IAAI,CAAC,MAAM,CAAC,wBAAwB,EAAE,CAAC,GAAG,EAAE;gBAC1C,IAAI,CAAC,oBAAoB,EAAE,EAAE,CAAC,IAAI,CAAC,mBAAmB,GAAG,KAAK,CAAC,CAAC;YAClE,CAAC,CAAC,CAAC;SACJ;IACH,CAAC;IAED,oBAAoB;QAClB,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;QACvB,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;QACpB,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QACzB,IAAI,CAAC,KAAK,GAAG,WAAW,CAAC;QACzB,IAAI,CAAC,YAAY,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC1C,IAAI,IAAI,CAAC,uBAAuB,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YAC1D,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACnC,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE,CAAC,EAAE,IAAI,CAAC,gBAAgB,IAAI,EAAE,CAAC,CAAC;YACrG,IAAI,CAAC,qBAAqB,EAAE,CAAC;YAC7B,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClC,IAAI,CAAC,uBAAuB,CAAC,KAAK,EAAE,CAAC;SACtC;QACD,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;IACzC,CAAC;IAES,eAAe,CAAC,SAAmB,EAAE,MAA8B;QAC3E,MAAM,IAAI,GAAa,EAAE,CAAC;QAE1B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YACzC,IAAI,CAAC,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;YACrB,IAAI,CAAC,CAAC,SAAS,KAAK,SAAS,EAAE;gBAC7B,CAAC,GAAG,CAAC,CAAC,gBAAgB,EAAE,CAAC,WAAW,CAAC,KAAK,CAAC;aAC5C;YACD,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE;gBACrB,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;aACd;SACF;QACD,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;YAEnB,IAAI,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,EAAE;gBACxC,OAAO;aACR;YACD,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC;YAEzC,KAAK,CAAC,MAAM,CACV;gBACE,aAAa,EAAE,IAAI,CAAC,aAAa;gBACjC,UAAU,EAAE,KAAK,KAAK,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS;gBACrE,YAAY,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC;aAChE,kBACC,WAAW,EAAE,IAAI,CAAC,WAAW,IAAK,MAAM,EAC3C,CAAC;QACJ,CAAC,CAAC,CAAC;QAGH,IAAI,IAAI,CAAC,gBAAgB,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE;YACvE,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAC1B;gBACE,aAAa,EAAE,IAAI,CAAC,aAAa;gBACjC,YAAY,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC;aAChE,kBACC,WAAW,EAAE,IAAI,CAAC,WAAW,IAAK,MAAM,EAC3C,CAAC;SACH;IACH,CAAC;IAED,YAAY,CAAC,CAAS,EAAE,CAAS,EAAE,WAAoB,IAAI;QACzD,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QACzB,QAAQ,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;IAC5B,CAAC;IAQD,MAAM,CAAC,CAAS,EAAE,CAAS,EAAE,WAAoB,IAAI;QACnD,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QACzB,IAAI,CAAC,eAAe,CAAS,CAAC,CAAC,EAAE;YAC/B,CAAC,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QACjB,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;YAClB,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC;SACnG;QAGD,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACjE,QAAQ,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;IAC5B,CAAC;IACD,UAAU,CAAC,CAAS,EAAE,CAAS,EAAE,WAAoB,IAAI;QACvD,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC;QAClG,IAAI,CAAC,eAAe,CAAS,CAAC,CAAC,EAAE;YAC/B,CAAC,CAAC,UAAU,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QACrB,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,mCAAQ,IAAI,CAAC,MAAM,CAAC,MAAM,KAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE,MAAM,EAAE,IAAI,CAAC,MAAM,GAAE,CAAC,CAAC;QACxG,QAAQ,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;IAC5B,CAAC;IAGD,UAAU,CAAC,CAAuB,EAAE,CAAmB,EAAE,CAAU,EAAE,CAAU,EAAE,QAAkB;QACjG,IAAI,UAAU,GAAY,IAAI,CAAC;QAE/B,IAAI,OAAO,CAAC,KAAK,QAAQ,EAAE;YACzB,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;YAC9C,IAAI,CAAC,KAAK,KAAK,EAAE;gBACf,UAAU,GAAG,KAAK,CAAC;aACpB;SACF;aAAM;YACL,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAW,EAAE,CAAC,GAAG,CAAC,EAAG,CAAY,GAAG,CAAC,CAAC,CAAC;YAEhE,IAAI,QAAQ,KAAK,KAAK,EAAE;gBACtB,UAAU,GAAG,KAAK,CAAC;aACpB;SACF;QAED,IAAI,CAAC,eAAe,CAAS,CAAC,CAAC,EAAE;YAC/B,CAAC,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC;QAC5D,CAAC,CAAC,CAAC;QACH,UAAU,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;IAC9B,CAAC;IACD,MAAM,CAAC,GAAW,EAAE,WAAoB,IAAI;QAE1C,IAAI,CAAC,eAAe,CAAS,CAAC,CAAC,EAAE;YAC/B,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAChB,CAAC,CAAC,CAAC;QAEH,QAAQ,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;IAC5B,CAAC;IACD,SAAS,CAAC,CAAS,EAAE,CAAS;QAC5B,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC;IAC1B,CAAC;IACD,MAAM,CAAC,IAAiB;QACtB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC;IAC1B,CAAC;IACD,IAAI,CAAC,CAAS,EAAE,CAAS;QACvB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACvB,IAAI,CAAC,aAAa,GAAG,qBAAS,CAAC,GAAG,CAAiB,yBAAa,CAAC,CAAC;SACnE;QAED,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,QAAiC,EAAE,IAAI,cAAK,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;YAC9F,MAAM,EAAE,IAAI,CAAC,UAAU;SACxB,CAAC,CAAC;QACH,IAAI,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,OAAO,MAAI,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,KAAK,CAAA,EAAE;YACpC,OAAO,MAAM,CAAC;SACf;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAGD,YAAY,CAAC,CAAS;QACpB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC;IAC1B,CAAC;IACD,UAAU,CAAC,CAAS;QAClB,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,CAAC;IAC1B,CAAC;IAED,OAAO;QACL,KAAK,CAAC,OAAO,EAAE,CAAC;QAChB,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;QAC/C,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,CAAC;QAC7B,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;YACnB,KAAK,CAAC,OAAO,EAAE,CAAC;QAClB,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,gBAAgB,IAAI,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,CAAC;QACzD,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;IACxB,CAAC;IAED,QAAQ,CAAC,KAAc;QACrB,OAAO;IAKT,CAAC;IAOD,KAAK,CAAC,CAAU,EAAE,MAAgB;QAChC,IAAI,MAAM,EAAE;YACV,CAAC,CAAC,mBAAmB,CAAC,MAAM,CAAC,CAAC;SAC/B;QACD,IAAI,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,EAAE;YAC5B,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;SACnD;QACD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IAC5B,CAAC;IAED,QAAQ,CAAC,IAAY;QACnB,MAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,KAAK,IAAI,CAAC,CAAC;QACjE,OAAO,KAAK,CAAC,CAAC,CAAW,CAAC;IAC5B,CAAC;IAED,QAAQ,CAAC,MAAe,EAAE,MAA+D;QACvF,IAAI,CAAC,eAAe,CAAS,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE;YACxC,KAAK,CAAC,MAAM,CAAC,MAAM,kCACd,MAAM,KACT,aAAa,EAAE,IAAI,CAAC,aAAa,EACjC,UAAU,EAAE,KAAK,KAAK,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS,EACrE,KAAK,EAAE,CAAC,KAAK,CAAC,EACd,YAAY,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC,IAC/D,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAOD,iBAAiB,CAAC,YAAqB,IAAI,EAAE,OAAqB;QAChE,MAAM,MAAM,GAAG,qBAAS,CAAC,GAAG,CAAU,gBAAO,CAAC,CAAC;QAC/C,IAAI,SAAS,EAAE;YACb,MAAM,CAAC,MAAM,CAAC;gBACZ,KAAK,EAAE,IAAI,CAAC,SAAS;gBACrB,MAAM,EAAE,IAAI,CAAC,UAAU;gBACvB,GAAG,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG;gBACpB,eAAe,EAAE,IAAI;gBACrB,SAAS,EAAE,IAAI;gBACf,KAAK,EAAE,EAAE;aACV,CAAC,CAAC;SACJ;aAAM;YACL,MAAM,KAAK,GAAG,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;YAC/F,MAAM,MAAM,GAAG,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;YACnG,MAAM,CAAC,MAAM,CAAC;gBACZ,KAAK;gBACL,MAAM;gBACN,GAAG,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG;gBACpB,eAAe,EAAE,IAAI;gBACrB,SAAS,EAAE,IAAI;gBACf,KAAK,EAAE,EAAE;aACV,CAAC,CAAC;SACJ;QAED,MAAM,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;QACpC,MAAM,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;QACpC,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE;YACpB,CAAC;YACD,CAAC;YACD,KAAK,EAAE,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK;YAC1C,MAAM,EAAE,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,MAAM;SAC7C,CAAC,CAAC;QACH,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,QAAQ,CAAC,YAAqB,IAAI,EAAE,OAAqB;QACvD,MAAM,MAAM,GAAG,IAAI,CAAC,iBAAiB,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC;QAC1D,MAAM,CAAC,GAAG,MAAM,CAAC,gBAAgB,EAAE,CAAC;QACpC,IAAI,CAAC,CAAC,YAAY,EAAE;YAClB,OAAO,CAAC,CAAC,YAAY,CAAC;SACvB;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAED,SAAS,CAAC,IAAa;QACrB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACpB,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;IAC7C,CAAC;IAED,SAAS;QACP,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;CACF;AAx2BD,sBAw2BC","file":"stage.js","sourcesContent":["import type { IAABBBounds, IBounds, IBoundsLike, IMatrix } from '@visactor/vutils';\nimport { AABBBounds, Bounds, Point, isString } from '@visactor/vutils';\nimport type {\n  IGraphic,\n  IExportType,\n  IStage,\n  IStageParams,\n  ILayer,\n  IColor,\n  IGlobal,\n  IOption3D,\n  ICamera,\n  vec3,\n  IDirectionLight,\n  ITicker,\n  IRenderService,\n  IPickerService,\n  IPluginService,\n  ISyncHook,\n  IDrawContext,\n  IWindow,\n  ILayerService,\n  ITimeline,\n  IOptimizeType,\n  LayerMode,\n  PickResult\n} from '../interface';\nimport { VWindow } from './window';\nimport type { Layer } from './layer';\nimport { EventSystem } from '../event';\nimport { container } from '../container';\nimport { RenderService } from '../render';\nimport { Group, Theme } from '../graphic';\nimport { PickerService } from '../picker/constants';\nimport { PluginService } from '../plugins/constants';\nimport { AutoRenderPlugin } from '../plugins/builtin-plugin/auto-render-plugin';\nimport { ViewTransform3dPlugin } from '../plugins/builtin-plugin/3dview-transform-plugin';\nimport { IncrementalAutoRenderPlugin } from '../plugins/builtin-plugin/incremental-auto-render-plugin';\nimport { HtmlAttributePlugin } from '../plugins/builtin-plugin/html-attribute-plugin';\nimport { DirtyBoundsPlugin } from '../plugins/builtin-plugin/dirty-bounds-plugin';\nimport { FlexLayoutPlugin } from '../plugins/builtin-plugin/flex-layout-plugin';\nimport { defaultTicker } from '../animate/default-ticker';\nimport { SyncHook } from '../tapable';\nimport { DirectionalLight } from './light';\nimport { OrthoCamera } from './camera';\nimport { LayerService } from './constants';\nimport { DefaultTimeline } from '../animate';\nimport { application } from '../application';\nimport { isBrowserEnv } from '../env-check';\n\nconst DefaultConfig = {\n  WIDTH: 500,\n  HEIGHT: 500,\n  X: 0,\n  Y: 0,\n  BACKGROUND: 'white'\n};\n\ntype IStageState = 'rendering' | 'normal';\n\n/**\n * Stage是一个舞台或一个视口，并不直接对应一个或多个Canvas，逻辑上和Canvas无关\n *\n * 1. Stage对应一个Canvas的整体，Stage的宽高即为Canvas的宽高\n * 2. Stage小于Canvas，Stage作为Canvas某个区域的视口，只管理这个区域\n * 3. 多图层时Stage的多个图层对应多个Canvas\n *\n * 原生环境下Stage可以拥有一个Window或者使用Window的一块区域\n *\n * 【注】如果希望获取完整的Canvas或窗口或者调整窗口信息，请使用Window模块\n */\nexport class Stage extends Group implements IStage {\n  declare parent: IStage | null;\n\n  declare state: IStageState;\n\n  protected _viewBox: AABBBounds;\n  private _background: string | IColor;\n  private _subView: boolean; // 是否是存在子视图\n  protected nextFrameRenderLayerSet: Set<Layer>;\n  protected willNextFrameRender: boolean;\n  protected _cursor: string;\n  renderCount: number;\n  dirtyBounds: IBounds | null;\n  option3d?: IOption3D;\n  declare light?: IDirectionLight;\n  declare camera?: ICamera;\n  declare renderStyle?: string;\n\n  declare hooks: {\n    beforeRender: ISyncHook<[IStage]>;\n    afterRender: ISyncHook<[IStage]>;\n  };\n\n  set viewBox(b: IBoundsLike) {\n    this._viewBox.setValue(b.x1, b.y1, b.x2, b.y2);\n  }\n  get viewBox(): AABBBounds {\n    return this._viewBox;\n  }\n\n  get x(): number {\n    return this._viewBox.x1;\n  }\n  set x(x: number) {\n    this._viewBox.translate(x - this._viewBox.x1, 0);\n  }\n  get y(): number {\n    return this._viewBox.y1;\n  }\n  set y(y: number) {\n    this._viewBox.translate(0, y - this._viewBox.y1);\n  }\n  get width(): number {\n    return this.window.width;\n  }\n  set width(w: number) {\n    this.resize(w, this.height);\n  }\n  get viewWidth(): number {\n    return this._viewBox.width();\n  }\n  set viewWidth(w: number) {\n    this.resizeView(w, this.viewHeight);\n  }\n  get viewHeight(): number {\n    return this._viewBox.height();\n  }\n  set viewHeight(h: number) {\n    this.resizeView(this.viewWidth, h);\n  }\n  get height(): number {\n    return this.window.height;\n  }\n  set height(h: number) {\n    this.resize(this.width, h);\n  }\n  get dpr(): number {\n    return this.window.dpr;\n  }\n  set dpr(r: number) {\n    this.setDpr(r);\n  }\n  get background(): string | IColor {\n    return this._background ?? DefaultConfig.BACKGROUND;\n  }\n  set background(b: string | IColor) {\n    this._background = b;\n  }\n  get defaultLayer(): ILayer {\n    return this.at(0) as unknown as ILayer;\n  }\n\n  ticker: ITicker;\n\n  autoRender: boolean;\n  _enableLayout: boolean;\n  htmlAttribute: boolean | string | any;\n  increaseAutoRender: boolean;\n  view3dTranform: boolean;\n  readonly window: IWindow;\n  private readonly global: IGlobal;\n  readonly renderService: IRenderService;\n  pickerService?: IPickerService;\n  readonly pluginService: IPluginService;\n  readonly layerService: ILayerService;\n  private _eventSystem?: EventSystem;\n  private get eventSystem(): EventSystem {\n    return this._eventSystem;\n  }\n\n  protected _beforeRender?: (stage: IStage) => void;\n  protected _afterRender?: (stage: IStage) => void;\n  // 0: 正常渲染, > 0: 跳过隐藏canvas的渲染, < 0: 禁止渲染\n  protected _skipRender?: number;\n  protected _afterNextRenderCbs?: ((stage: IStage) => void)[];\n  protected lastRenderparams?: Partial<IDrawContext>;\n\n  protected interactiveLayer?: ILayer;\n  protected supportInteractiveLayer: boolean;\n  protected timeline: ITimeline;\n\n  declare params: Partial<IStageParams>;\n\n  /**\n   * 所有属性都具有默认值。\n   * Canvas为字符串或者Canvas元素，那么默认图层就会绑定到这个Canvas上\n   * 如果不传入Canvas，那么会新建一个Canvas，用户可以通过Window模块管理这个Canvas\n   * 1. 如果没有传入宽高，那么默认为canvas宽高，如果传入了宽高则stage使用传入宽高作为视口宽高\n   * @param params\n   */\n  constructor(params: Partial<IStageParams> = {}) {\n    super({});\n    this.params = params;\n    this.theme = new Theme();\n    this.hooks = {\n      beforeRender: new SyncHook(['stage']),\n      afterRender: new SyncHook(['stage'])\n    };\n    this.global = application.global;\n    if (!this.global.env && isBrowserEnv()) {\n      // 如果是浏览器环境，默认设置env\n      this.global.setEnv('browser');\n    }\n    this.window = container.get<IWindow>(VWindow);\n    this.renderService = container.get<IRenderService>(RenderService);\n    this.pluginService = container.get<IPluginService>(PluginService);\n    this.layerService = container.get<ILayerService>(LayerService);\n    this.pluginService.active(this, params);\n\n    this.window.create({\n      width: params.width,\n      height: params.height,\n      container: params.container,\n      dpr: params.dpr || this.global.devicePixelRatio,\n      canvasControled: params.canvasControled !== false,\n      title: params.title || '',\n      canvas: params.canvas\n    });\n\n    this._viewBox = new AABBBounds();\n    if (params.viewBox) {\n      this._viewBox.setValue(params.viewBox.x1, params.viewBox.y1, params.viewBox.x2, params.viewBox.y2);\n    } else {\n      this._viewBox.setValue(0, 0, this.width, this.height);\n    }\n\n    this.state = 'normal';\n    this.renderCount = 0;\n    this.tryInitEventSystem();\n    // // 没有传入xy就默认为0\n    // this._x = params.x ?? DefaultConfig.X;\n    // this._y = params.y ?? DefaultConfig.Y;\n    // // 没有传入view的宽高则默认为window的宽高\n    // this._viewWidth = params.viewWidth ?? this.window.width;\n    // this._viewHeight = params.viewHeight ?? this.window.height;\n    this._subView = !(this._viewBox.width() === this.width && this._viewBox.height() === this.height);\n    // this._AABBBounds.set(this._x, this._y, this._viewWidth + this._x, this._viewHeight + this._y);\n    // 背景色默认为纯白色\n    this._background = params.background ?? DefaultConfig.BACKGROUND;\n\n    // 创建一个默认layer图层\n    // this.appendChild(new Layer(this, this.global, this.window, { main: true }));\n    this.appendChild(this.layerService.createLayer(this, { main: true }));\n\n    this.nextFrameRenderLayerSet = new Set();\n    this.willNextFrameRender = false;\n    this.stage = this;\n    this.renderStyle = params.renderStyle;\n\n    // this.autoRender = params.autoRender;\n    if (params.autoRender) {\n      this.enableAutoRender();\n    }\n    // 默认不开启dirtyBounds\n    if (params.disableDirtyBounds === false) {\n      this.enableDirtyBounds();\n    }\n\n    if (params.enableHtmlAttribute) {\n      this.enableHtmlAttribute(params.enableHtmlAttribute);\n    }\n\n    params.enableLayout && this.enableLayout();\n    this.hooks.beforeRender.tap('constructor', this.beforeRender);\n    this.hooks.afterRender.tap('constructor', this.afterRender);\n    this._beforeRender = params.beforeRender;\n    this._afterRender = params.afterRender;\n    this.ticker = params.ticker || defaultTicker;\n    this.supportInteractiveLayer = params.interactiveLayer !== false;\n    this.timeline = new DefaultTimeline();\n    this.ticker.addTimeline(this.timeline);\n    this.timeline.pause();\n    if (!params.optimize) {\n      params.optimize = {};\n    }\n    this.optmize(params.optimize);\n    // 如果背景是图片，触发加载图片操作\n    if (params.background && isString(this._background) && this._background.includes('/')) {\n      this.setAttributes({ background: this._background });\n    }\n  }\n\n  protected tryInitEventSystem() {\n    if (this.global.supportEvent && !this._eventSystem) {\n      this._eventSystem = new EventSystem({\n        targetElement: this.window,\n        resolution: this.window.dpr || this.global.devicePixelRatio,\n        rootNode: this as any,\n        global: this.global,\n        supportsPointerEvents: this.params.supportsPointerEvents,\n        supportsTouchEvents: this.params.supportsTouchEvents,\n        viewport: {\n          viewBox: this._viewBox,\n          get x(): number {\n            return this.viewBox.x1;\n          },\n          get y(): number {\n            return this.viewBox.y1;\n          },\n          get width(): number {\n            return this.viewBox.width();\n          },\n          get height(): number {\n            return this.viewBox.height();\n          }\n        },\n        ...this.params.event\n      });\n    }\n  }\n\n  preventRender(prevent: boolean) {\n    if (prevent) {\n      this._skipRender = -Infinity;\n    } else {\n      // 判断是否需要outRange优化\n      if (this.params.optimize.skipRenderWithOutRange !== false) {\n        this._skipRender = this.window.isVisible() ? 0 : 1;\n      } else {\n        this._skipRender = 0;\n      }\n    }\n  }\n\n  // 优化策略\n  optmize(params: IOptimizeType) {\n    this.optmizeRender(params.skipRenderWithOutRange);\n    this.params.optimize = params;\n  }\n\n  // 优化渲染\n  protected optmizeRender(skipRenderWithOutRange: boolean = false) {\n    if (!skipRenderWithOutRange) {\n      return;\n    }\n    // 不在视口内的时候，跳过渲染\n    this._skipRender = this._skipRender < 0 ? this._skipRender : this.window.isVisible() ? 0 : 1;\n    this.window.onVisibleChange(this._onVisibleChange);\n  }\n\n  protected _onVisibleChange = (visible: boolean) => {\n    if (this._skipRender < 0) {\n      return;\n    }\n    if (visible) {\n      if (this.dirtyBounds) {\n        this.dirtyBounds.setValue(0, 0, this._viewBox.width(), this._viewBox.height());\n      }\n      if (this._skipRender > 1) {\n        this.renderNextFrame();\n      }\n      this._skipRender = 0;\n    } else {\n      this._skipRender = 1;\n    }\n  };\n\n  getTimeline() {\n    return this.timeline;\n  }\n\n  get3dOptions(options: IOption3D) {\n    const {\n      center = { x: this.width / 2, y: this.height / 2, z: 0, dx: 0, dy: 0, dz: 0 },\n      light = {},\n      alpha = 0,\n      beta = 0,\n      camera,\n      fieldRatio = 1,\n      fieldDepth\n    } = options;\n\n    return {\n      ...options,\n      center,\n      light,\n      alpha,\n      beta,\n      camera,\n      fieldRatio,\n      fieldDepth\n    };\n  }\n\n  set3dOptions(options: IOption3D) {\n    this.option3d = options;\n    const options3d = this.get3dOptions(options);\n    const { light, center, camera, alpha, beta, fieldRatio, fieldDepth } = options3d;\n    const { dir = [1, 1, -1], color = 'white', ambient } = light;\n\n    const centerX = (center.x ?? this.width / 2) + (center.dx ?? 0);\n    const centerY = (center.y ?? this.height / 2) + (center.dy ?? 0);\n    const centerZ = (center.z ?? 0) + (center.dz ?? 0);\n    const centerVec3: vec3 = [centerX, centerY, centerZ];\n    const z = 1;\n    let cameraX = 0;\n    let cameraY = 0;\n    let cameraZ = 0;\n    if (!camera) {\n      cameraX = Math.sin(alpha) + centerX;\n      cameraY = Math.sin(beta) + centerY;\n      cameraZ = Math.cos(alpha) * Math.cos(beta) * z;\n    }\n\n    this.light = new DirectionalLight(dir, color, ambient);\n    const cameraParams = {\n      left: 0,\n      right: this.width,\n      top: 0,\n      bottom: this.height,\n      fieldRatio: fieldRatio,\n      fieldDepth,\n      viewParams: {\n        pos: [cameraX, cameraY, cameraZ] as vec3,\n        center: centerVec3,\n        up: [0, 1, 0] as vec3\n      }\n    };\n    if (this.camera) {\n      this.camera.params = cameraParams;\n    } else {\n      this.camera = new OrthoCamera(cameraParams);\n    }\n\n    if (options.enableView3dTransform) {\n      this.enableView3dTransform();\n    }\n  }\n\n  protected beforeRender = (stage: IStage) => {\n    this._beforeRender && this._beforeRender(stage);\n  };\n\n  protected afterRender = (stage: IStage) => {\n    this.renderCount++;\n    this._afterRender && this._afterRender(stage);\n    this._afterNextRenderCbs && this._afterNextRenderCbs.forEach(cb => cb(stage));\n    this._afterNextRenderCbs = null;\n  };\n\n  setBeforeRender(cb: (stage: IStage) => void) {\n    this._beforeRender = cb;\n  }\n\n  setAfterRender(cb: (stage: IStage) => void) {\n    this._afterRender = cb;\n  }\n\n  afterNextRender(cb: (stage: IStage) => void) {\n    if (!this._afterNextRenderCbs) {\n      this._afterNextRenderCbs = [];\n    }\n    this._afterNextRenderCbs.push(cb);\n  }\n\n  enableView3dTransform() {\n    if (this.view3dTranform) {\n      return;\n    }\n    this.view3dTranform = true;\n    this.pluginService.register(new ViewTransform3dPlugin());\n  }\n\n  disableView3dTranform() {\n    if (!this.view3dTranform) {\n      return;\n    }\n    this.view3dTranform = false;\n    this.pluginService.findPluginsByName('ViewTransform3dPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n\n  enableAutoRender() {\n    if (this.autoRender) {\n      return;\n    }\n    this.autoRender = true;\n    this.pluginService.register(new AutoRenderPlugin());\n  }\n  disableAutoRender() {\n    if (!this.autoRender) {\n      return;\n    }\n    this.autoRender = false;\n    this.pluginService.findPluginsByName('AutoRenderPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableIncrementalAutoRender() {\n    if (this.increaseAutoRender) {\n      return;\n    }\n    this.increaseAutoRender = true;\n    this.pluginService.register(new IncrementalAutoRenderPlugin());\n  }\n  disableIncrementalAutoRender() {\n    if (!this.increaseAutoRender) {\n      return;\n    }\n    this.increaseAutoRender = false;\n    this.pluginService.findPluginsByName('IncrementalAutoRenderPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableDirtyBounds() {\n    if (this.dirtyBounds) {\n      return;\n    }\n    this.dirtyBounds = new Bounds();\n    let plugin = this.pluginService.findPluginsByName('DirtyBoundsPlugin')[0];\n    if (!plugin) {\n      plugin = new DirtyBoundsPlugin();\n      this.pluginService.register(plugin);\n    } else {\n      plugin.activate(this.pluginService);\n    }\n  }\n  disableDirtyBounds() {\n    if (!this.dirtyBounds) {\n      return;\n    }\n    this.dirtyBounds = null;\n    this.pluginService.findPluginsByName('DirtyBoundsPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableLayout() {\n    if (this._enableLayout) {\n      return;\n    }\n    this._enableLayout = true;\n    this.pluginService.register(new FlexLayoutPlugin());\n  }\n  disableLayout() {\n    if (!this._enableLayout) {\n      return;\n    }\n    this._enableLayout = false;\n    this.pluginService.findPluginsByName('FlexLayoutPlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n  enableHtmlAttribute(container?: any) {\n    if (this.htmlAttribute) {\n      return;\n    }\n    this.htmlAttribute = container;\n    this.pluginService.register(new HtmlAttributePlugin());\n  }\n  disableHtmlAttribute() {\n    if (!this.htmlAttribute) {\n      return;\n    }\n    this.htmlAttribute = false;\n    this.pluginService.findPluginsByName('HtmlAttributePlugin').forEach(plugin => {\n      this.pluginService.unRegister(plugin);\n    });\n  }\n\n  // /**\n  //  * stage的appendChild，add\n  //  * @param node\n  //  * @returns\n  //  */\n  // appendChild<T extends Node>(node: T): T | null {\n  //   const layer = this.at(0);\n  //   if (!layer) {\n  //     return null;\n  //   }\n  //   return layer.appendChild<T>(node);\n  // }\n\n  protected tryUpdateAABBBounds(): AABBBounds {\n    const viewBox = this._viewBox;\n    this._AABBBounds.setValue(viewBox.x1, viewBox.y1, viewBox.x2, viewBox.y2);\n    return this._AABBBounds;\n  }\n\n  combineLayer(ILayer1: ILayer, ILayer2: ILayer): ILayer {\n    throw new Error('暂不支持');\n  }\n  // 如果传入CanvasId，如果存在相同Id，说明这两个图层使用相同的Canvas绘制\n  // 但需要注意的是依然是两个图层（用于解决Table嵌入ChartSpace不影响Table的绘制）\n  createLayer(canvasId?: string, layerMode?: LayerMode): ILayer {\n    // 创建一个默认layer图层\n    const layer = this.layerService.createLayer(this, {\n      main: false,\n      layerMode,\n      canvasId\n    });\n    this.appendChild(layer);\n    return layer;\n    // const layer = new Layer(this, this.global, this.window, {\n    //   main: false,\n    //   canvasId\n    // });\n    // this.appendChild(layer);\n    // return layer;\n  }\n  sortLayer(cb: (ILayer1: ILayer, layer2: ILayer) => number): void {\n    const children = this.children;\n    children.sort(cb);\n    this.removeAllChild();\n    children.forEach(c => {\n      this.appendChild(c);\n    });\n  }\n  removeLayer(ILayerId: number): ILayer | false {\n    return this.removeChild(this.findChildByUid(ILayerId) as IGraphic) as ILayer;\n  }\n  tryInitInteractiveLayer() {\n    // TODO：顺序可能会存在问题\n    // 支持交互层，且没有创建过，那就创建\n    if (this.supportInteractiveLayer && !this.interactiveLayer) {\n      this.interactiveLayer = this.createLayer();\n      this.interactiveLayer.name = '_builtin_interactive';\n      this.interactiveLayer.attribute.pickable = false;\n      this.nextFrameRenderLayerSet.add(this.interactiveLayer as any); // to be fixed\n    }\n    // this.interactiveLayer.afterDraw(l => {\n    //   l.removeAllChild();\n    // });\n  }\n\n  clearViewBox(color?: string) {\n    this.window.clearViewBox(this._viewBox, color);\n  }\n\n  render(layers?: ILayer[], params?: Partial<IDrawContext>): void {\n    this.ticker.start();\n    this.timeline.resume();\n    const state = this.state;\n    this.state = 'rendering';\n    this.layerService.prepareStageLayer(this);\n    if (!this._skipRender) {\n      this.lastRenderparams = params;\n      this.hooks.beforeRender.call(this);\n      this.renderLayerList(this.children as ILayer[]);\n      this.combineLayersToWindow();\n      this.nextFrameRenderLayerSet.clear();\n      this.hooks.afterRender.call(this);\n    }\n    this.state = state;\n    this._skipRender && this._skipRender++;\n  }\n\n  protected combineLayersToWindow() {\n    return;\n    // this.forEach<ILayer>((layer, i) => {\n    //   layer.combineTo(this.window, {\n    //     clear: i === 0,\n    //     x: this.x,\n    //     y: this.y,\n    //     width: this.viewWidth,\n    //     height: this.viewHeight,\n    //     renderService: this.renderService,\n    //     background: layer === this.defaultLayer ? this.background : undefined,\n    //     updateBounds: !!this.dirtyBounds\n    //   });\n    // });\n  }\n\n  renderNextFrame(layers?: ILayer[], force?: boolean): void {\n    // render状态中调用的不会触发nextFrame，避免loop\n    // if (this.state === 'rendering' && !force) {\n    //   console.log('abc');\n    //   return;\n    // }\n    // 性能优化，避免重复add\n    if (this.nextFrameRenderLayerSet.size !== this.childrenCount) {\n      (layers || this).forEach<ILayer>((layer: any) => {\n        this.nextFrameRenderLayerSet.add(layer);\n      });\n    }\n    if (!this.willNextFrameRender) {\n      this.willNextFrameRender = true;\n      this.global.getRequestAnimationFrame()(() => {\n        this._doRenderInThisFrame(), (this.willNextFrameRender = false);\n      });\n    }\n  }\n\n  _doRenderInThisFrame() {\n    this.timeline.resume();\n    this.ticker.start();\n    const state = this.state;\n    this.state = 'rendering';\n    this.layerService.prepareStageLayer(this);\n    if (this.nextFrameRenderLayerSet.size && !this._skipRender) {\n      this.hooks.beforeRender.call(this);\n      this.renderLayerList(Array.from(this.nextFrameRenderLayerSet.values()), this.lastRenderparams || {});\n      this.combineLayersToWindow();\n      this.hooks.afterRender.call(this);\n      this.nextFrameRenderLayerSet.clear();\n    }\n    this.state = state;\n    this._skipRender && this._skipRender++;\n  }\n\n  protected renderLayerList(layerList: ILayer[], params?: Partial<IDrawContext>) {\n    const list: ILayer[] = [];\n    // 只需要render main layer即可\n    for (let i = 0; i < layerList.length; i++) {\n      let l = layerList[i];\n      if (l.layerMode === 'virtual') {\n        l = l.getNativeHandler().mainHandler.layer;\n      }\n      if (!list.includes(l)) {\n        list.push(l);\n      }\n    }\n    list.forEach(layer => {\n      // 记录当前的stamp，避免重复绘制layer（如果存在virtual layer）\n      if (layer.renderCount > this.renderCount) {\n        return;\n      }\n      layer.renderCount = this.renderCount + 1;\n\n      layer.render(\n        {\n          renderService: this.renderService,\n          background: layer === this.defaultLayer ? this.background : undefined,\n          updateBounds: !!(this.dirtyBounds && !this.dirtyBounds.empty())\n        },\n        { renderStyle: this.renderStyle, ...params }\n      );\n    });\n\n    // 添加交互层渲染\n    if (this.interactiveLayer && !layerList.includes(this.interactiveLayer)) {\n      this.interactiveLayer.render(\n        {\n          renderService: this.renderService,\n          updateBounds: !!(this.dirtyBounds && !this.dirtyBounds.empty())\n        },\n        { renderStyle: this.renderStyle, ...params }\n      );\n    }\n  }\n\n  resizeWindow(w: number, h: number, rerender: boolean = true) {\n    this.window.resize(w, h);\n    rerender && this.render();\n  }\n\n  /**\n   * 语法糖，如果viewBox和window宽高一样的话，那么会同时缩放window和viewBox\n   * @param w\n   * @param h\n   * @param rerender\n   */\n  resize(w: number, h: number, rerender: boolean = true): void {\n    this.window.resize(w, h);\n    this.forEachChildren<ILayer>(c => {\n      c.resize(w, h);\n    });\n    // 如果不是子图的stage，那么认为用户也想要resize view\n    if (!this._subView) {\n      this.viewBox.setValue(this.viewBox.x1, this.viewBox.y1, this.viewBox.x1 + w, this.viewBox.y1 + h);\n    }\n    // 设置camera\n    // this.camera && (this.camera.params = { ...this.camera.params, right: this.width, bottom: this.height });\n    this.camera && this.option3d && this.set3dOptions(this.option3d);\n    rerender && this.render();\n  }\n  resizeView(w: number, h: number, rerender: boolean = true) {\n    this.viewBox.setValue(this.viewBox.x1, this.viewBox.y1, this.viewBox.x1 + w, this.viewBox.y1 + h);\n    this.forEachChildren<ILayer>(c => {\n      c.resizeView(w, h);\n    });\n    // 设置camera\n    this.camera && (this.camera.params = { ...this.camera.params, right: this.width, bottom: this.height });\n    rerender && this.render();\n  }\n  setViewBox(viewBox: IBoundsLike, rerender: boolean): void;\n  setViewBox(x: number, y: number, w: number, h: number, rerender: boolean): void;\n  setViewBox(x: number | IBoundsLike, y: number | boolean, w?: number, h?: number, rerender?: boolean): void {\n    let isRerender: boolean = true;\n\n    if (typeof x === 'object') {\n      this.viewBox.setValue(x.x1, x.y1, x.x2, x.y2);\n      if (y === false) {\n        isRerender = false;\n      }\n    } else {\n      this.viewBox.setValue(x, y as number, x + w, (y as number) + h);\n\n      if (rerender === false) {\n        isRerender = false;\n      }\n    }\n\n    this.forEachChildren<ILayer>(c => {\n      c.resizeView(this.viewBox.width(), this.viewBox.height());\n    });\n    isRerender && this.render();\n  }\n  setDpr(dpr: number, rerender: boolean = true): void {\n    // this.window.setDpr(dpr);\n    this.forEachChildren<ILayer>(c => {\n      c.setDpr(dpr);\n    });\n\n    rerender && this.render();\n  }\n  setOrigin(x: number, y: number): void {\n    throw new Error('暂不支持');\n  }\n  export(type: IExportType): HTMLCanvasElement | ImageData {\n    throw new Error('暂不支持');\n  }\n  pick(x: number, y: number): PickResult | false {\n    if (!this.pickerService) {\n      this.pickerService = container.get<IPickerService>(PickerService);\n    }\n    // 暂时不提供layer的pick\n    const result = this.pickerService.pick(this.children as unknown as IGraphic[], new Point(x, y), {\n      bounds: this.AABBBounds\n    });\n    if (result?.graphic || result?.group) {\n      return result;\n    }\n    return false;\n  }\n\n  // 动画相关\n  startAnimate(t: number): void {\n    throw new Error('暂不支持');\n  }\n  setToFrame(t: number): void {\n    throw new Error('暂不支持');\n  }\n\n  release() {\n    super.release();\n    this.eventSystem && this.eventSystem.release();\n    this.pluginService.release();\n    this.forEach(layer => {\n      layer.release();\n    });\n    this.interactiveLayer && this.interactiveLayer.release();\n    this.window.release();\n  }\n\n  setStage(stage?: IStage) {\n    return;\n    // this.stage = this;\n    // this.forEachChildren(item => {\n    //   (item as Layer).setStage(this);\n    // });\n  }\n\n  /**\n   * 添加dirty区域，会修改参数b\n   * @param b\n   * @param matrix\n   */\n  dirty(b: IBounds, matrix?: IMatrix) {\n    if (matrix) {\n      b.transformWithMatrix(matrix);\n    }\n    if (this.dirtyBounds.empty()) {\n      this.dirtyBounds.setValue(b.x1, b.y1, b.x2, b.y2);\n    }\n    this.dirtyBounds.union(b);\n  }\n\n  getLayer(name: string): undefined | ILayer {\n    const layer = this.children.filter(layer => layer.name === name);\n    return layer[0] as ILayer;\n  }\n\n  renderTo(window: IWindow, params: { x: number; y: number; width: number; height: number }) {\n    this.forEachChildren<ILayer>((layer, i) => {\n      layer.drawTo(window, {\n        ...params,\n        renderService: this.renderService,\n        background: layer === this.defaultLayer ? this.background : undefined,\n        clear: i === 0, // 第一个layer需要clear\n        updateBounds: !!(this.dirtyBounds && !this.dirtyBounds.empty())\n      });\n    });\n  }\n\n  /**\n   * 渲染到新的window上去\n   * @param fullImage 是否是全量的image，因为可能之前的window有一部分场景树超过window的帧缓冲了\n   * @returns\n   */\n  renderToNewWindow(fullImage: boolean = true, viewBox?: IAABBBounds): IWindow {\n    const window = container.get<IWindow>(VWindow);\n    if (fullImage) {\n      window.create({\n        width: this.viewWidth,\n        height: this.viewHeight,\n        dpr: this.window.dpr,\n        canvasControled: true,\n        offscreen: true,\n        title: ''\n      });\n    } else {\n      const width = viewBox ? viewBox.width() : Math.min(this.viewWidth, this.window.width - this.x);\n      const height = viewBox ? viewBox.height() : Math.min(this.viewHeight, this.window.height - this.y);\n      window.create({\n        width,\n        height,\n        dpr: this.window.dpr,\n        canvasControled: true,\n        offscreen: true,\n        title: ''\n      });\n    }\n\n    const x = viewBox ? -viewBox.x1 : 0;\n    const y = viewBox ? -viewBox.y1 : 0;\n    this.renderTo(window, {\n      x,\n      y,\n      width: viewBox ? viewBox.x2 : window.width,\n      height: viewBox ? viewBox.y2 : window.height\n    });\n    return window;\n  }\n\n  toCanvas(fullImage: boolean = true, viewBox?: IAABBBounds): HTMLCanvasElement | null {\n    const window = this.renderToNewWindow(fullImage, viewBox);\n    const c = window.getNativeHandler();\n    if (c.nativeCanvas) {\n      return c.nativeCanvas;\n    }\n    return null;\n  }\n\n  setCursor(mode?: string): void {\n    this._cursor = mode;\n    this.eventSystem.setCursor(mode, 'ignore');\n  }\n\n  getCursor() {\n    return this._cursor;\n  }\n}\n"]}