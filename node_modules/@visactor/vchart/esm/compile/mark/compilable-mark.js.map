{"version":3,"sources":["../src/compile/mark/compilable-mark.ts"],"names":[],"mappings":"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","file":"compilable-mark.js","sourcesContent":["import type {\n  IElement,\n  IGroupMark,\n  IMark,\n  IMarkConfig,\n  MarkAnimationSpec,\n  MarkFunctionCallback,\n  MarkFunctionType,\n  Nil,\n  TransformSpec\n} from '@visactor/vgrammar-core';\n// eslint-disable-next-line no-duplicate-imports\nimport type { GrammarMarkType } from '@visactor/vgrammar-core';\nimport type { DataView } from '@visactor/vdataset';\nimport { GrammarItem } from '../grammar-item';\nimport type { Maybe, Datum, StringOrNumber } from '../../typings';\nimport { array, isNil, isValid } from '@visactor/vutils';\nimport { LayoutZIndex, PREFIX, VGRAMMAR_HOOK_EVENT } from '../../constant';\nimport type { IMarkProgressiveConfig, IMarkStateStyle, MarkType } from '../../mark/interface';\nimport type { IModel } from '../../model/interface';\nimport type { ISeries } from '../../series/interface';\nimport { isStateAttrChangeable } from './util';\nimport { MarkStateManager } from './mark-state-manager';\nimport type {\n  ICompilableMark,\n  IMarkDataInitOption,\n  ICompilableMarkOption,\n  StateValueType,\n  IMarkCompileOption,\n  IAttributeOpt\n} from './interface';\n// eslint-disable-next-line no-duplicate-imports\nimport { STATE_VALUE_ENUM } from './interface';\nimport { MarkData } from './mark-data';\nimport { GrammarType } from '../interface/compilable-item';\nimport type { IComponent } from '../../component/interface';\nimport type { IEvent } from '../../event/interface';\nimport { Event } from '../../event/event';\n// eslint-disable-next-line no-duplicate-imports\nimport { AnimationStateEnum } from '../../animation/interface';\nimport type { ICustomPath2D } from '@visactor/vrender-core';\n\n/** 可编译的 mark 对象，这个基类只存放编译相关的逻辑 */\nexport abstract class CompilableMark extends GrammarItem implements ICompilableMark {\n  readonly grammarType = GrammarType.mark;\n  /** 类型 */\n  readonly type: MarkType = undefined as unknown as MarkType;\n\n  /** name */\n  readonly name: string = 'mark';\n\n  /** key field */\n  readonly key: ICompilableMark['key'];\n\n  protected _skipTheme?: boolean;\n  getSkipTheme() {\n    return this._skipTheme;\n  }\n  setSkipTheme(skipTheme: boolean) {\n    this._skipTheme = skipTheme;\n  }\n\n  /** 3d开关 */\n  protected _support3d?: boolean;\n  getSupport3d() {\n    return this._support3d;\n  }\n  setSupport3d(support3d: boolean) {\n    this._support3d = support3d;\n  }\n\n  /** 分片 */\n  protected _facet?: string;\n  getFacet() {\n    return this._facet;\n  }\n  setFacet(facet: string) {\n    this._facet = facet;\n  }\n\n  /** 交互开关 */\n  protected _interactive: boolean = true;\n  getInteractive() {\n    return this._interactive;\n  }\n  setInteractive(interactive: boolean) {\n    this._interactive = interactive;\n  }\n\n  /** 层级 */\n  protected _zIndex: number = LayoutZIndex.Mark;\n  getZIndex() {\n    return this._zIndex;\n  }\n  setZIndex(zIndex: number) {\n    this._zIndex = zIndex;\n  }\n\n  /** 可见性 */\n  protected _visible: boolean = true;\n  getVisible() {\n    return this._visible;\n  }\n  setVisible(visible: boolean) {\n    this._visible = visible;\n  }\n\n  /**\n   * 用户设置的 id\n   */\n  protected _userId: StringOrNumber;\n  getUserId() {\n    return this._userId;\n  }\n  setUserId(userId: StringOrNumber) {\n    if (isValid(userId)) {\n      this._userId = userId;\n    }\n  }\n\n  /** parent model */\n  readonly model: IModel;\n\n  /** 数据（可以没有） */\n  protected _data: Maybe<MarkData>;\n  getDataView(): DataView | undefined {\n    return this._data?.getDataView();\n  }\n  setDataView(d?: DataView, productId?: string) {\n    if (isNil(this._data)) {\n      this.initMarkData({\n        ...this._option,\n        mark: this\n      });\n    }\n    if (isValid(productId)) {\n      this._data.setCompiledProductId(productId);\n    }\n    this._data.setDataView(d);\n  }\n  getData() {\n    return this._data;\n  }\n  setData(d?: MarkData) {\n    this._data = d;\n  }\n\n  /** 默认的stateStyle */\n  stateStyle: IMarkStateStyle<any> = {};\n\n  /** 状态管理器 */\n  state: MarkStateManager;\n\n  protected _unCompileChannel: { [key in string]: boolean } = {};\n\n  hasState(state: string) {\n    return state in this.state.getStateMap();\n  }\n  getState(state: string) {\n    return this.state.getStateMap()[state];\n  }\n\n  protected _event: IEvent;\n\n  protected _animationConfig: Partial<MarkAnimationSpec>;\n  getAnimationConfig() {\n    return this._animationConfig;\n  }\n  setAnimationConfig(config: Partial<MarkAnimationSpec>) {\n    this._animationConfig = config;\n  }\n\n  /** 布局标记 */\n  private _skipBeforeLayouted = false;\n\n  setSkipBeforeLayouted(skip: boolean) {\n    this._skipBeforeLayouted = skip;\n  }\n  getSkipBeforeLayouted(): boolean {\n    return this._skipBeforeLayouted;\n  }\n\n  /** morph动画关联关系配置 */\n  protected _morph: boolean = false;\n  getMorph() {\n    return this._morph;\n  }\n  setMorph(morph: boolean) {\n    this._morph = morph;\n  }\n  protected _morphKey?: string;\n  getMorphKey() {\n    return this._morphKey;\n  }\n  setMorphKey(morphKey: string) {\n    this._morphKey = morphKey;\n  }\n  protected _morphElementKey?: string;\n  getMorphElementKey() {\n    return this._morphElementKey;\n  }\n  setMorphElementKey(key: string) {\n    this._morphElementKey = key;\n  }\n\n  protected _groupKey?: string;\n  getGroupKey() {\n    return this._groupKey;\n  }\n  setGroupKey(groupKey: string) {\n    this._groupKey = groupKey;\n  }\n\n  protected _progressiveConfig: IMarkProgressiveConfig;\n  getProgressiveConfig() {\n    return this._progressiveConfig;\n  }\n  setProgressiveConfig(config: IMarkProgressiveConfig) {\n    this._progressiveConfig = config;\n  }\n\n  protected _setCustomizedShape?: (datum: any[], attrs: any, path: ICustomPath2D) => ICustomPath2D;\n  setCustomizedShapeCallback(callback: (datum: any[], attrs: any, path: ICustomPath2D) => ICustomPath2D) {\n    this._setCustomizedShape = callback;\n  }\n\n  protected _enableSegments: boolean;\n  setEnableSegments(enable: boolean) {\n    this._enableSegments = enable;\n  }\n\n  protected declare _option: ICompilableMarkOption;\n\n  constructor(option: ICompilableMarkOption, name: string, model: IModel) {\n    super(option);\n    this.name = name;\n    this.model = model;\n    this.key = option.key;\n    this.state = new MarkStateManager(\n      {\n        ...option,\n        stateKeyToSignalName: this.stateKeyToSignalName.bind(this)\n      },\n      this\n    );\n    this._option.support3d && this.setSupport3d(true);\n    this._option.skipTheme && this.setSkipTheme(true);\n    this._event = new Event(model.getOption().eventDispatcher, model.getOption().mode);\n  }\n\n  protected declare _product: Maybe<IMark>;\n  declare getProduct: () => Maybe<IMark>;\n\n  // transform目前在形状词云中使用，但直接用的 vgrammar 接口 (this._wordMark as ICompilableMark).getProduct().transform(wordCloudTransforms);\n  // 暂时没有用到这里的setTransform()\n  protected _transform: TransformSpec[] | Nil;\n  setTransform(transform: TransformSpec[] | Nil) {\n    this._transform = transform;\n  }\n\n  /** 初始化 mark data */\n  protected initMarkData(option: IMarkDataInitOption) {\n    this._data = new MarkData(option);\n  }\n\n  protected stateKeyToSignalName(key: string) {\n    return `${PREFIX}_${this.type}_${this.id}_${key}`;\n  }\n\n  getAttribute(key: any, datum: any, state: StateValueType, opt?: IAttributeOpt) {\n    // do nothing\n  }\n\n  protected _compileProduct(option?: IMarkCompileOption) {\n    const product = this.getProduct();\n    // 处理 visible 为 false 的情况\n    if (!this.getVisible()) {\n      if (isValid(product)) {\n        this.removeProduct();\n      }\n      return;\n    } else if (isValid(product)) {\n      return; // 每个mark只执行一次编译\n    }\n\n    const compiler = this.getCompiler();\n    if (!compiler.isInited) {\n      return;\n    }\n    this._initProduct(option?.group);\n    if (isNil(this._product)) {\n      return;\n    }\n\n    this.compileSignal();\n    this.compileData();\n    this.compileState();\n    this.compileEncode();\n    this.compileAnimation();\n    this.compileContext();\n    this.compileTransform();\n  }\n\n  /** 创建语法元素对象 */\n  protected _initProduct(group?: string | IGroupMark) {\n    const view = this.getVGrammarView();\n\n    // 声明语法元素\n    const id = this.getProductId();\n    this._product = view.mark(this.type as GrammarMarkType, group ?? view.rootMark).id(id);\n    this._compiledProductId = id;\n  }\n\n  generateProductId() {\n    if (this._userId) {\n      return `${this._userId}`;\n    }\n    return `${this.name}_${this.id}`;\n  }\n\n  compileData() {\n    if (isNil(this._data)) {\n      return;\n    }\n    this._data.compile();\n\n    // 绑定数据\n    const dataProduct = this._data.getProduct();\n    if (isValid(this._product) && isValid(dataProduct)) {\n      this._product.join(dataProduct, this.key, undefined, this._groupKey ?? this._facet);\n    }\n  }\n\n  updateStaticEncode() {\n    if (!this._product) {\n      return;\n    }\n    const { enterStyles, updateStyles } = this._separateStyle();\n\n    this._product.encodeState('group', enterStyles, true);\n\n    this._product.encode(updateStyles, true);\n  }\n\n  protected _separateStyle() {\n    const { [STATE_VALUE_ENUM.STATE_NORMAL]: normalStyle, ...temp } = this.stateStyle;\n\n    const enterStyles: Record<string, MarkFunctionType<any>> = this._option.noSeparateStyle ? null : {};\n    const updateStyles: Record<string, MarkFunctionType<any>> = {};\n    Object.keys(normalStyle).forEach(key => {\n      if (this._unCompileChannel[key]) {\n        return;\n      }\n\n      if (this._option.noSeparateStyle || isStateAttrChangeable(key, normalStyle, this.getFacet())) {\n        updateStyles[key] = {\n          callback: this.compileCommonAttributeCallback(key, 'normal'),\n          dependency: [this.stateKeyToSignalName('markUpdateRank')]\n        };\n      } else {\n        enterStyles[key] = this.compileCommonAttributeCallback(key, 'normal');\n      }\n    });\n    return { enterStyles, updateStyles };\n  }\n\n  compileEncode() {\n    const { [STATE_VALUE_ENUM.STATE_NORMAL]: normalStyle, ...temp } = this.stateStyle;\n    const { enterStyles, updateStyles } = this._separateStyle();\n    this._product.encode(updateStyles, true);\n    this._product.encodeState('group', enterStyles, true);\n\n    Object.keys(temp).forEach(state => {\n      const styles: Record<string, MarkFunctionType<any>> = {};\n      Object.keys(temp[state]).forEach(key => {\n        if (this._unCompileChannel[key]) {\n          return;\n        }\n        styles[key] = {\n          callback: this.compileCommonAttributeCallback(key, state),\n          dependency: [this.stateKeyToSignalName('markUpdateRank')]\n        };\n      });\n      this._product.encodeState(state, styles, true);\n    });\n\n    // 在布局完成前不进行encode\n    if (this._skipBeforeLayouted) {\n      this._product.layout({\n        skipBeforeLayouted: this._skipBeforeLayouted\n      });\n    }\n  }\n\n  compileState() {\n    this.state.compileState(this._product);\n  }\n\n  compileAnimation() {\n    if (this._animationConfig) {\n      let stateSignal: any;\n      if (this.type === 'component') {\n        // 组件有自己的动画状态\n        stateSignal = (this.model as IComponent).animate?.getAnimationStateSignalName();\n      } else {\n        const region = (this.model as ISeries).getRegion();\n        stateSignal = region.animate?.getAnimationStateSignalName();\n      }\n      this._product.animation(this._animationConfig);\n      this._product.animationState({\n        callback: (datum: Datum, element: IElement, parameters: Record<string, any>) => {\n          return parameters[stateSignal]?.callback(datum, element);\n        },\n        dependency: stateSignal\n      });\n      if (this._animationConfig.normal) {\n        this._event.on(VGRAMMAR_HOOK_EVENT.ANIMATION_END, ({ event }) => {\n          if (event.mark === this.getProduct() && event.animationState === AnimationStateEnum.appear) {\n            this.runAnimationByState(AnimationStateEnum.normal);\n          }\n        });\n      }\n    }\n  }\n\n  compileContext() {\n    const config: IMarkConfig = {\n      interactive: this.getInteractive(),\n      zIndex: this.getZIndex(),\n      context: {\n        markId: this.id,\n        modelId: this.model.id,\n        markUserId: this._userId,\n        modelUserId: this.model.userId\n      },\n      skipTheme: this.getSkipTheme(),\n      support3d: this.getSupport3d(),\n      enableSegments: !!this._enableSegments\n    };\n\n    if (this._progressiveConfig) {\n      config.progressiveStep = this._progressiveConfig.progressiveStep;\n      config.progressiveThreshold = this._progressiveConfig.progressiveThreshold;\n      config.large = this._progressiveConfig.large;\n      config.largeThreshold = this._progressiveConfig.largeThreshold;\n    }\n\n    if (this._morph && this._morphKey) {\n      config.morph = this._morph;\n      config.morphKey = this._morphKey;\n      config.morphElementKey = this._morphElementKey;\n    }\n\n    if (this._setCustomizedShape) {\n      config.setCustomizedShape = this._setCustomizedShape;\n    }\n\n    this._product.configure(config);\n  }\n\n  compileSignal() {\n    this.state.compile();\n  }\n\n  protected _computeAttribute(key: string, state: StateValueType) {\n    return (datum: Datum, opt: IAttributeOpt) => {\n      return undefined as any;\n    };\n  }\n\n  // TODO: 1. opt内容待定，确实需要再来补充（之前是scale.bindScales/bindSignals，从context.params中可以获取到）\n  // TODO: 2. stateSourceItem，是否根据attr区分，存在默认写死的情况，例如\"hover\"/\"normal\"；\n  protected compileCommonAttributeCallback(key: string, state: string): MarkFunctionCallback<any> {\n    const attributeFunctor = this._computeAttribute(key, state);\n    // remove state in opt\n    const opt: IAttributeOpt = { mark: null, parent: null, element: null };\n    return (datum: Datum, element: IElement) => {\n      opt.mark = element.mark;\n      opt.parent = element.mark.group;\n      opt.element = element;\n      return attributeFunctor(datum, opt);\n    };\n  }\n\n  protected compileTransform() {\n    if (this._transform?.length) {\n      this.getProduct().transform(this._transform);\n    }\n  }\n\n  protected _lookupGrammar(id: string) {\n    return this.getCompiler().getVGrammarView()?.getMarkById(id);\n  }\n\n  updateState(newState: Record<string, unknown>, noRender?: boolean) {\n    return this.state.updateState(newState, noRender);\n  }\n\n  updateLayoutState(noRender?: boolean, recursion?: boolean): Promise<void> {\n    if (recursion && this.getMarks().length > 0) {\n      this.getMarks().forEach(m => m.state.updateLayoutState(true));\n    }\n    return this.state.updateLayoutState(noRender);\n  }\n\n  updateMarkState(key: string): void {\n    if (!this._product) {\n      return;\n    }\n    const stateInfo = this.state.getStateInfo(key);\n    this._product.elements.forEach(e => {\n      if (this.state.checkOneState(e, e.getDatum(), stateInfo) === 'in') {\n        e.addState(key);\n      } else {\n        e.removeState(key);\n      }\n    });\n  }\n\n  getMarks(): ICompilableMark[] {\n    return [];\n  }\n\n  runAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.runAnimationByState(state);\n  }\n\n  stopAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.stopAnimationByState(state);\n  }\n\n  pauseAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.pauseAnimationByState(state);\n  }\n\n  resumeAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.resumeAnimationByState(state);\n  }\n\n  release() {\n    super.release();\n    this.state.release();\n  }\n}\n"]}