{"version":3,"sources":["../src/interaction/interaction.ts"],"names":[],"mappings":"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","file":"interaction.js","sourcesContent":["import { isEmpty } from '@visactor/vutils';\nimport type { StateValue } from '../compile/mark';\nimport type { IElement } from '@visactor/vgrammar-core';\nimport type { BaseEventParams } from '../event/interface';\nimport type { IMark } from '../mark/interface';\nimport type { IInteraction } from './interface';\nimport { stateToReverse } from '../compile/mark/util';\n\nexport class Interaction implements IInteraction {\n  // 数据\n  private _stateMarks: Map<StateValue, IMark[]> = new Map();\n  // active\n  private _stateElements: Map<StateValue, IElement[]> = new Map();\n\n  static markStateEnable(mark: IMark, state: string) {\n    return !isEmpty(mark.stateStyle[state]);\n  }\n\n  private _disableTriggerEvent: boolean = false;\n\n  setDisableActiveEffect(disable: boolean) {\n    this._disableTriggerEvent = disable;\n  }\n\n  registerMark(state: StateValue, mark: IMark): void {\n    if (!this._stateMarks.has(state)) {\n      this._stateMarks.set(state, []);\n    }\n    this._stateMarks.get(state)?.push(mark);\n  }\n\n  getStateMark(state: StateValue): IMark[] | null {\n    return this._stateMarks.get(state);\n  }\n\n  filterEventMark(params: BaseEventParams, state: StateValue): boolean {\n    return !!(params.mark && this._stateMarks.get(state)?.includes(params.mark));\n  }\n\n  getEventElement(stateValue: StateValue) {\n    return this._stateElements.get(stateValue) ?? [];\n  }\n\n  getEventElementData(stateValue: StateValue) {\n    return this.getEventElement(stateValue).map(e => e.getDatum());\n  }\n\n  exchangeEventElement(stateValue: StateValue, element: IElement) {\n    if (this._disableTriggerEvent) {\n      return;\n    }\n    // reverse\n    const reState = stateToReverse(stateValue);\n    this._stateElements.get(stateValue)?.forEach(e => {\n      e.removeState(stateValue);\n      if (reState) {\n        this.addEventElement(reState, e);\n      }\n    });\n    if (!element.getStates().includes(stateValue)) {\n      element.addState(stateValue);\n      if (reState) {\n        element.removeState(reState);\n      }\n    }\n    this._stateElements.set(stateValue, [element]);\n  }\n\n  removeEventElement(stateValue: StateValue, element: IElement) {\n    if (this._disableTriggerEvent) {\n      return;\n    }\n    element.removeState(stateValue);\n    const list = this._stateElements.get(stateValue)?.filter(e => e !== element) ?? [];\n    this._stateElements.set(stateValue, list);\n    // reverse\n    const reState = stateToReverse(stateValue);\n    if (reState) {\n      if (list.length === 0) {\n        // clear reverse\n        this.clearEventElement(reState, false);\n      } else {\n        // add reverse to element\n        this.addEventElement(reState, element);\n      }\n    }\n  }\n\n  addEventElement(stateValue: StateValue, element: IElement) {\n    if (this._disableTriggerEvent) {\n      return;\n    }\n    if (!element.getStates().includes(stateValue)) {\n      element.addState(stateValue);\n    }\n    const list = this._stateElements.get(stateValue) ?? [];\n    list.push(element);\n    this._stateElements.set(stateValue, list);\n  }\n\n  clearEventElement(stateValue: StateValue, clearReverse: boolean) {\n    if (this._disableTriggerEvent) {\n      return;\n    }\n    this._stateElements.get(stateValue)?.forEach(e => {\n      e.removeState(stateValue);\n    });\n    this._stateElements.set(stateValue, []);\n\n    if (clearReverse) {\n      const reState = stateToReverse(stateValue);\n      if (reState) {\n        this.clearEventElement(reState, false);\n      }\n    }\n  }\n\n  /**\n   * 激活交互元素时 进行反选\n   * 需要先将元素添加到已交互状态再使用此方法反选\n   * @param stateValue\n   * @param activeElement\n   * @returns\n   */\n  reverseEventElement(stateValue: StateValue) {\n    if (this._disableTriggerEvent) {\n      return;\n    }\n    // TODO:直接加默认后缀？or再增加一个map？\n    const state = stateToReverse(stateValue);\n    if (!state) {\n      return;\n    }\n    const marks = this.getStateMark(state);\n    if (!marks) {\n      return;\n    }\n    const activeElements = this.getEventElement(stateValue);\n    if (!activeElements.length) {\n      return;\n    }\n    const currentReverse = this.getEventElement(state);\n    if (!currentReverse.length) {\n      // all\n      // for performance array.include\n      // FIXME: 也许并没有太大必要\n      if (activeElements.length === 1) {\n        marks.forEach(m => {\n          m.getProduct()\n            .elements.filter(e => e !== activeElements[0])\n            .forEach(e => {\n              this.addEventElement(state, e);\n            });\n        });\n      } else {\n        marks.forEach(m => {\n          m.getProduct()\n            .elements.filter(e => !activeElements.includes(e))\n            .forEach(e => {\n              this.addEventElement(state, e);\n            });\n        });\n      }\n    }\n  }\n}\n"]}