{"version":3,"sources":["../src/series/map/map.ts"],"names":[],"mappings":"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","file":"map.js","sourcesContent":["import { Matrix, isValid, isValidNumber } from '@visactor/vutils';\n/* eslint-disable no-duplicate-imports */\nimport type { FeatureData } from '@visactor/vgrammar-core';\nimport { registerProjection } from '@visactor/vgrammar-projection';\nimport { DataView } from '@visactor/vdataset';\nimport type { IPathMark } from '../../mark/path';\nimport { geoSourceMap, registerMapSource, unregisterMapSource } from './geo-source';\nimport { lookup } from '../../data/transforms/lookup';\nimport type { Maybe, Datum, StringOrNumber } from '../../typings';\nimport { GeoSeries } from '../geo/geo';\nimport { DEFAULT_MAP_LOOK_UP_KEY, map } from '../../data/transforms/map';\nimport { copyDataView } from '../../data/transforms/copy-data-view';\nimport { registerDataSetInstanceTransform } from '../../data/register';\nimport { MapSeriesTooltipHelper } from './tooltip-helper';\nimport { AttributeLevel, DEFAULT_DATA_SERIES_FIELD, DEFAULT_DATA_INDEX } from '../../constant/index';\nimport type { SeriesMarkMap } from '../interface';\nimport { SeriesMarkNameEnum, SeriesTypeEnum } from '../interface/type';\nimport type { IMapSeriesSpec, IMapSeriesTheme } from './interface';\nimport { SeriesData } from '../base/series-data';\nimport type { PanEventParam, ZoomEventParam } from '../../event/interface';\nimport { animationConfig, shouldMarkDoMorph, userAnimationConfig } from '../../animation/utils';\nimport { registerFadeInOutAnimation } from '../../animation/config';\nimport { PathMark, registerPathMark } from '../../mark/path';\nimport { mapSeriesMark } from './constant';\nimport type { ILabelMark } from '../../mark/label';\nimport { Factory } from '../../core/factory';\nimport { registerGeoCoordinate } from '../../component/geo';\nimport type { IMark } from '../../mark/interface';\nimport { TransformLevel } from '../../data/initialize';\nimport { MapSeriesSpecTransformer } from './map-transformer';\n\nexport class MapSeries<T extends IMapSeriesSpec = IMapSeriesSpec> extends GeoSeries<T> {\n  static readonly type: string = SeriesTypeEnum.map;\n  type = SeriesTypeEnum.map;\n\n  static readonly mark: SeriesMarkMap = mapSeriesMark;\n  static readonly transformerConstructor = MapSeriesSpecTransformer as any;\n  readonly transformerConstructor = MapSeriesSpecTransformer;\n\n  map!: string;\n\n  protected _nameMap!: { [key: StringOrNumber]: StringOrNumber };\n  getNameMap() {\n    return this._nameMap;\n  }\n\n  private _areaCache: Map<string, { shape: string }> = new Map();\n  get areaPath() {\n    return this._areaCache;\n  }\n\n  private _pathMark: IPathMark;\n  private _labelMark: ILabelMark;\n\n  setAttrFromSpec() {\n    super.setAttrFromSpec();\n    this.map = this._spec.map;\n    this._nameMap = this._spec.nameMap;\n    this._nameField = this._spec.nameField;\n    this._valueField = this._spec.valueField;\n    this._spec.nameProperty && (this._nameProperty = this._spec.nameProperty);\n    this._spec.centroidProperty && (this._centroidProperty = this._spec.centroidProperty);\n\n    if (!this.map) {\n      this._option?.onError(`map type '${this.map}' is not specified !`);\n    }\n\n    if (!geoSourceMap.get(this.map)) {\n      this._option?.onError(`'${this.map}' data is not registered !`);\n    }\n  }\n\n  // data\n  initData(): void {\n    super.initData();\n\n    registerDataSetInstanceTransform(this._dataSet, 'copyDataView', copyDataView);\n    registerDataSetInstanceTransform(this._dataSet, 'map', map);\n    registerDataSetInstanceTransform(this._dataSet, 'lookup', lookup);\n\n    // 初始化地图数据\n    const features = geoSourceMap.get(this.map);\n    if (!features) {\n      this._option?.onError('no valid map data found!');\n    }\n    const mapData = new DataView(this._dataSet, { name: `map_${this.id}_data` });\n\n    mapData\n      .parse([features], {\n        type: 'dataview'\n      })\n      .transform({ type: 'copyDataView', options: { deep: true }, level: TransformLevel.copyDataView })\n      .transform({\n        type: 'map',\n        options: {\n          nameMap: this._nameMap,\n          nameProperty: this._nameProperty\n        }\n      })\n      .transform({\n        type: 'lookup',\n        options: {\n          from: () => this._data?.getLatestData(),\n          key: DEFAULT_MAP_LOOK_UP_KEY,\n          fields: this._nameField,\n          set: (feature: FeatureData, datum: Datum) => {\n            if (datum) {\n              Object.keys(datum).forEach(key => {\n                if (!(key in feature)) {\n                  feature[key] = datum[key];\n                }\n              });\n            }\n          }\n        }\n      });\n    this._data?.getDataView().target.addListener('change', mapData.reRunAllTransform);\n    this._mapViewData = new SeriesData(this._option, mapData);\n  }\n\n  // mark\n  initMark() {\n    this._pathMark = this._createMark(MapSeries.mark.area, {\n      morph: shouldMarkDoMorph(this._spec, MapSeries.mark.area.name),\n      defaultMorphElementKey: this.getDimensionField()[0],\n      groupKey: this.getDimensionField()[0],\n      isSeriesMark: true,\n      skipBeforeLayouted: true,\n      dataView: this._mapViewData.getDataView(),\n      dataProductId: this._mapViewData.getProductId()\n    }) as IPathMark;\n  }\n\n  initMarkStyle() {\n    const pathMark = this._pathMark;\n    if (pathMark) {\n      this.setMarkStyle(\n        pathMark,\n        {\n          fill: (datum: any) => {\n            if (isValid(datum[this._seriesField ?? DEFAULT_DATA_SERIES_FIELD])) {\n              return (this._option.globalScale.getScale('color') ?? this._getDefaultColorScale()).scale(\n                datum[this._seriesField ?? DEFAULT_DATA_SERIES_FIELD]\n              );\n            }\n            return this._spec?.defaultFillColor;\n          },\n          path: this.getPath.bind(this)\n        },\n        'normal',\n        AttributeLevel.Series\n      );\n\n      pathMark.setPostProcess('fill', result => {\n        if (!isValid(result)) {\n          return this._spec.defaultFillColor;\n        }\n        return result;\n      });\n\n      this.setMarkStyle(\n        pathMark,\n        {\n          smoothScale: true\n        },\n        'normal',\n        AttributeLevel.Built_In\n      );\n      this._trigger.registerMark(pathMark);\n    }\n  }\n\n  initLabelMarkStyle(labelMark: ILabelMark) {\n    if (!labelMark) {\n      return;\n    }\n    this._labelMark = labelMark;\n    this.setMarkStyle(labelMark, {\n      text: (datum: Datum) => {\n        const text = this.getDatumName(datum);\n        return text;\n      },\n      x: (datum: Datum) => this.dataToPosition(datum)?.x,\n      y: (datum: Datum) => this.dataToPosition(datum)?.y\n    });\n  }\n\n  initAnimation() {\n    this._pathMark.setAnimationConfig(\n      animationConfig(\n        Factory.getAnimationInKey('fadeInOut')?.(),\n        userAnimationConfig(SeriesMarkNameEnum.area, this._spec, this._markAttributeContext)\n      )\n    );\n  }\n\n  protected initTooltip() {\n    this._tooltipHelper = new MapSeriesTooltipHelper(this);\n    this._pathMark && this._tooltipHelper.activeTriggerSet.mark.add(this._pathMark);\n  }\n\n  protected getPath(datum: any) {\n    const area = this._areaCache.get(datum[DEFAULT_DATA_INDEX]);\n    if (area) {\n      return area.shape;\n    }\n    const shape = this._coordinateHelper?.shape(datum);\n    this._areaCache.set(datum[DEFAULT_DATA_INDEX], {\n      shape\n    });\n    return shape;\n  }\n\n  // life cycle\n  onEvaluateEnd() {\n    this._mapViewData.updateData();\n  }\n\n  getDimensionField(): string[] {\n    return [this.nameField];\n  }\n\n  getMeasureField(): string[] {\n    return [this.valueField];\n  }\n\n  release() {\n    super.release();\n    this._areaCache.clear();\n    this._nameMap = {};\n    this._trigger = this._mapViewData = null as any;\n  }\n\n  handleZoom(e: ZoomEventParam) {\n    const { scale, scaleCenter } = e;\n    if (scale === 1) {\n      return;\n    }\n\n    const pathGroup = this.getRootMark().getProduct()?.getGroupGraphicItem();\n    if (pathGroup) {\n      if (!pathGroup.attribute.postMatrix) {\n        pathGroup.setAttributes({\n          postMatrix: new Matrix()\n        });\n      }\n      pathGroup.scale(scale, scale, scaleCenter);\n    }\n    const vgrammarLabel = this._labelMark?.getComponent()?.getProduct();\n\n    if (vgrammarLabel) {\n      vgrammarLabel.evaluateSync(null, null);\n    }\n  }\n\n  handlePan(e: PanEventParam) {\n    const { delta } = e;\n    if (delta[0] === 0 && delta[1] === 0) {\n      return;\n    }\n    const pathGroup = this.getRootMark().getProduct()?.getGroupGraphicItem();\n    if (pathGroup) {\n      if (!pathGroup.attribute.postMatrix) {\n        pathGroup.setAttributes({\n          postMatrix: new Matrix()\n        });\n      }\n      pathGroup.translate(delta[0], delta[1]);\n    }\n    const vgrammarLabel = this._labelMark?.getComponent()?.getProduct();\n\n    if (vgrammarLabel) {\n      vgrammarLabel.evaluateSync(null, null);\n    }\n  }\n\n  getDatumCenter(datum: any): [number, number] {\n    if (this._centroidProperty && datum.properties?.[this._centroidProperty]) {\n      return datum.properties?.[this._centroidProperty];\n    }\n\n    if (isValidNumber(datum.centroidX * datum.centroidY)) {\n      return [datum.centroidX, datum.centroidY];\n    }\n\n    if (datum.properties?.center) {\n      return datum.properties.center;\n    }\n\n    if (datum.properties?.centroid) {\n      return datum.properties.centroid;\n    }\n\n    return [Number.NaN, Number.NaN];\n  }\n\n  getDatumName(datum: any): string {\n    if (datum[this.nameField]) {\n      return datum[this.nameField];\n    }\n    if (datum.properties?.[this._nameProperty]) {\n      if (this._spec?.nameMap) {\n        return this._spec.nameMap[datum.properties[this._nameProperty]] ?? '';\n      }\n      return datum.properties[this._nameProperty] ?? '';\n    }\n    return '';\n  }\n\n  dataToPositionX(data: any): number {\n    this._option?.onError('Method not implemented.');\n    return 0;\n  }\n  dataToPositionY(data: any): number {\n    this._option?.onError('Method not implemented.');\n    return 0;\n  }\n\n  viewDataUpdate(d: DataView): void {\n    super.viewDataUpdate(d);\n    this._mapViewData?.getDataView()?.reRunAllTransform();\n    this._mapViewData?.updateData();\n  }\n\n  protected _getDataIdKey() {\n    return DEFAULT_DATA_INDEX;\n  }\n\n  getActiveMarks(): IMark[] {\n    return [this._pathMark];\n  }\n}\n\nexport const registerMapSeries = () => {\n  // 注册语法元素\n  registerProjection();\n  registerGeoCoordinate();\n  registerPathMark();\n  Factory.registerSeries(MapSeries.type, MapSeries);\n  Factory.registerImplement('registerMap', registerMapSource);\n  Factory.registerImplement('unregisterMap', unregisterMapSource);\n  registerFadeInOutAnimation();\n};\n"]}