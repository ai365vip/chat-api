{"version":3,"sources":["../src/component/marker/mark-point/mark-point.ts"],"names":[],"mappings":"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","file":"mark-point.js","sourcesContent":["import { DataView } from '@visactor/vdataset';\nimport type { IMarkPoint, IMarkPointCoordinateSpec, IMarkPointSpec } from './interface';\nimport { ComponentTypeEnum } from '../../interface/type';\nimport { markerAggregation } from '../../../data/transforms/aggregation';\nimport { computeClipRange, coordinateLayout, positionLayout, transformLabelAttributes, xyLayout } from '../utils';\nimport { registerDataSetInstanceTransform } from '../../../data/register';\nimport type { MarkPointAttrs } from '@visactor/vrender-components';\nimport { MarkPoint as MarkPointComponent } from '@visactor/vrender-components';\nimport type { Maybe } from '@visactor/vutils';\n// eslint-disable-next-line no-duplicate-imports\nimport { isEmpty, isValid, isArray } from '@visactor/vutils';\nimport { transformToGraphic } from '../../../util/style';\nimport { BaseMarker } from '../base-marker';\nimport { LayoutZIndex } from '../../../constant';\nimport { Factory } from '../../../core/factory';\nimport type { IGroup } from '@visactor/vrender-core';\nimport type { IPoint } from '../../../typings';\nimport type { IModelSpecInfo } from '../../../model/interface';\n\nexport class MarkPoint extends BaseMarker<IMarkPointSpec> implements IMarkPoint {\n  static type = ComponentTypeEnum.markPoint;\n  type = ComponentTypeEnum.markPoint;\n  name: string = ComponentTypeEnum.markPoint;\n\n  static specKey = 'markPoint';\n  specKey = 'markPoint';\n\n  layoutZIndex: number = LayoutZIndex.MarkPoint;\n\n  // markPoint组件\n  protected declare _markerComponent: MarkPointComponent;\n\n  static getSpecInfo(chartSpec: any): Maybe<IModelSpecInfo[]> {\n    const markPointSpec = chartSpec[this.specKey];\n    if (isEmpty(markPointSpec)) {\n      return undefined;\n    }\n    if (!isArray(markPointSpec) && markPointSpec.visible !== false) {\n      return [\n        {\n          spec: markPointSpec,\n          specPath: [this.specKey],\n          type: ComponentTypeEnum.markPoint\n        }\n      ];\n    }\n    const specInfos: IModelSpecInfo[] = [];\n    markPointSpec.forEach((m: any, i: number) => {\n      if (m.visible !== false) {\n        specInfos.push({\n          spec: m,\n          specIndex: i,\n          specPath: [this.specKey, i],\n          type: ComponentTypeEnum.markPoint\n        });\n      }\n    });\n    return specInfos;\n  }\n\n  protected _createMarkerComponent() {\n    const { itemContent = {}, itemLine = {} } = this._spec;\n    const { text: label = {}, symbol, image, richText, ...restItemContent } = itemContent;\n\n    const markPointAttrs: MarkPointAttrs = {\n      zIndex: this.layoutZIndex,\n      interactive: this._spec.interactive ?? false,\n      position: { x: 0, y: 0 },\n      clipInRange: this._spec.clip ?? false,\n      itemContent: {\n        symbolStyle: transformToGraphic(symbol?.style),\n        imageStyle: image?.style,\n        textStyle: transformLabelAttributes(label),\n        richTextStyle: richText?.style,\n        ...restItemContent // Tips: 因为网站 demo 上已经透出了 imageStyle richTextStyle 的写法，为了兼容所以这个需要在后面覆盖\n      }\n    };\n\n    const { visible, line = {}, ...restItemLine } = itemLine;\n    if (visible !== false) {\n      markPointAttrs.itemLine = {\n        ...restItemLine,\n        visible: true,\n        lineStyle: transformToGraphic(line.style)\n      };\n    } else {\n      markPointAttrs.itemLine = {\n        visible: false\n      };\n    }\n\n    const markPoint = new MarkPointComponent(markPointAttrs);\n    return markPoint as unknown as IGroup;\n  }\n\n  protected _markerLayout() {\n    const spec = this._spec;\n    const data = this._markerData;\n    const relativeSeries = this._relativeSeries;\n    const isXYLayout = 'x' in spec && 'y' in spec;\n    const isCoordinateLayout = 'coordinate' in spec;\n    const isPositionLayout = 'position' in spec;\n    const autoRange = spec?.autoRange ?? false;\n\n    let point: IPoint;\n    if (isXYLayout) {\n      point = xyLayout(data, relativeSeries, relativeSeries, relativeSeries, autoRange)[0][0];\n    } else if (isCoordinateLayout) {\n      point = coordinateLayout(\n        data,\n        relativeSeries,\n        autoRange,\n        (spec as IMarkPointCoordinateSpec).coordinatesOffset\n      )[0];\n    } else if (isPositionLayout) {\n      point = positionLayout([spec.position], relativeSeries, spec.regionRelative)[0];\n    }\n\n    const seriesData = this._relativeSeries.getViewData().latestData;\n    const dataPoints = data\n      ? data.latestData[0].latestData\n        ? data.latestData[0].latestData\n        : data.latestData\n      : seriesData;\n\n    let limitRect;\n    if (spec.clip || spec.itemContent?.confine) {\n      const { minX, maxX, minY, maxY } = computeClipRange([relativeSeries.getRegion()]);\n      limitRect = {\n        x: minX,\n        y: minY,\n        width: maxX - minX,\n        height: maxY - minY\n      };\n    }\n    if (this._markerComponent) {\n      const attribute = this._markerComponent.attribute ?? {};\n      const textStyle = attribute.itemContent?.textStyle ?? {};\n      this._markerComponent.setAttributes({\n        position: point,\n        itemContent: {\n          ...attribute.itemContent,\n          textStyle: {\n            ...textStyle,\n            text: this._spec.itemContent.text?.formatMethod\n              ? this._spec.itemContent.text.formatMethod(dataPoints, seriesData)\n              : textStyle.text\n          }\n        },\n        limitRect,\n        dx: this._layoutOffsetX,\n        dy: this._layoutOffsetY\n      });\n    }\n  }\n\n  protected _initDataView(): void {\n    const spec = this._spec as any;\n    const relativeSeries = this._relativeSeries;\n    const isXYProcess = isValid(spec.x) && isValid(spec.y);\n    const isCoordinateProcess = isValid(spec.coordinate);\n    if (!isCoordinateProcess && !isXYProcess) {\n      return;\n    }\n\n    registerDataSetInstanceTransform(this._option.dataSet, 'markerAggregation', markerAggregation);\n\n    let options;\n    if (isXYProcess) {\n      options = [this._processSpecXY(spec.x, spec.y)];\n    } else if (isCoordinateProcess) {\n      options = this._processSpecCoo(spec);\n    }\n\n    const data = new DataView(this._option.dataSet, { name: `${this.type}_${this.id}_data` });\n    data.parse([relativeSeries.getViewData()], {\n      type: 'dataview'\n    });\n    data.transform({\n      type: 'markerAggregation',\n      options\n    });\n\n    data.target.on('change', () => {\n      this._markerLayout();\n    });\n    this._markerData = data;\n  }\n}\n\nexport const registerMarkPoint = () => {\n  Factory.registerComponent(MarkPoint.type, MarkPoint);\n};\n"]}