{"version":3,"sources":["../src/player/discrete-player.ts"],"names":[],"mappings":"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","file":"discrete-player.js","sourcesContent":["import { isNil, merge } from '@visactor/vutils';\nimport type { FederatedPointerEvent } from '@visactor/vrender-core';\nimport { vglobal } from '@visactor/vrender-core';\nimport { BasePlayer } from './base-player';\nimport type { DirectionType, DiscretePlayerAttributes, PlayerAttributes } from './type';\nimport { DirectionEnum, PlayerEventEnum } from './type';\nimport { forwardStep, isReachEnd, isReachStart } from './utils';\nimport { ControllerEventEnum } from './controller/constant';\nimport type { ComponentOptions } from '../interface';\nimport { loadDiscretePlayerComponent } from './register';\n\nexport interface IDiscretePlayer {\n  play: () => void;\n  pause: () => void;\n  backward: () => void;\n  forward: () => void;\n}\n\nloadDiscretePlayerComponent();\nexport class DiscretePlayer extends BasePlayer<DiscretePlayerAttributes> implements IDiscretePlayer {\n  declare attribute: DiscretePlayerAttributes;\n\n  private _dataIndex: number;\n  private _activeIndex = -1;\n\n  protected _alternate: boolean;\n  protected _interval: number;\n\n  private _isPlaying: boolean;\n  private _direction: DirectionType;\n  private _tickTime: number;\n  private _rafId: number;\n  private _isReachEnd = false;\n\n  constructor(attributes: DiscretePlayerAttributes, options?: ComponentOptions) {\n    super(options?.skipDefault ? attributes : merge({}, attributes));\n\n    this._initAttributes();\n    this._initEvents();\n  }\n\n  setAttributes(params: Partial<Required<PlayerAttributes>>, forceUpdateTag?: boolean): void {\n    super.setAttributes(params, forceUpdateTag);\n\n    this._initAttributes();\n  }\n\n  /**\n   * 初始化属性\n   */\n  _initAttributes = () => {\n    super._initAttributes();\n    this._alternate = this.attribute.alternate ?? false;\n    this._interval = this.attribute.interval ?? 1000;\n    this._direction = this.attribute.direction ?? DirectionEnum.Default;\n\n    this._dataIndex = isNil(this.attribute.dataIndex)\n      ? this._direction === 'default'\n        ? this._minIndex\n        : this._maxIndex\n      : this.attribute.dataIndex ?? 0;\n\n    this._slider.setAttribute('value', this._dataIndex);\n  };\n\n  /**\n   * 初始化事件\n   */\n  private _initEvents = () => {\n    if (this.attribute.disableTriggerEvent) {\n      return;\n    }\n    this._controller.addEventListener(ControllerEventEnum.OnPlay, (e: FederatedPointerEvent) => {\n      e.stopPropagation();\n      this.play();\n    });\n    this._controller.addEventListener(ControllerEventEnum.OnPause, (e: FederatedPointerEvent) => {\n      e.stopPropagation();\n      this.pause();\n    });\n    this._controller.addEventListener(ControllerEventEnum.OnForward, (e: FederatedPointerEvent) => {\n      e.stopPropagation();\n      this.forward();\n    });\n    this._controller.addEventListener(ControllerEventEnum.OnBackward, (e: FederatedPointerEvent) => {\n      e.stopPropagation();\n      this.backward();\n    });\n\n    this._slider.addEventListener('change', (e: FederatedPointerEvent & { detail: { value: number } }) => {\n      const middle = Math.floor(e.detail.value) + 0.5;\n      this._dataIndex = e.detail.value >= middle ? Math.ceil(e.detail.value) : Math.floor(e.detail.value);\n      this._slider.setValue(this._dataIndex);\n      this.dispatchCustomEvent(PlayerEventEnum.change);\n    });\n  };\n\n  /**\n   * 派遣事件\n   */\n  dispatchCustomEvent(event: PlayerEventEnum) {\n    super.dispatchCustomEvent(event, this._dataIndex);\n  }\n\n  /**\n   * 播放接口\n   */\n  play = () => {\n    if (this._isPlaying) {\n      return;\n    }\n    // 一条数据无需播放\n    if (this._data.length === 1) {\n      return;\n    }\n    // 图标切换\n    this._controller.togglePause();\n    // 播放状态更新\n    this._isPlaying = true;\n    // 若到达末尾, 则计算下一次播放的状态下标\n    if (\n      isReachEnd({\n        dataIndex: this._dataIndex,\n        maxIndex: this._maxIndex,\n        minIndex: this._minIndex,\n        direction: this._direction\n      }) ||\n      isReachStart({\n        dataIndex: this._dataIndex,\n        maxIndex: this._maxIndex,\n        minIndex: this._minIndex,\n        direction: this._direction\n      })\n    ) {\n      // 根据方向恢复dataIndex\n      if (this._direction === DirectionEnum.Default) {\n        this._updateDataIndex(this._minIndex);\n      } else {\n        this._updateDataIndex(this._maxIndex);\n      }\n    }\n\n    // 事件触发\n    this.dispatchCustomEvent(PlayerEventEnum.play);\n    // 重置结束状态\n    this._isReachEnd = false;\n    // 重置tick时间, 暂停后重新播放也会重新计时\n    this._tickTime = Date.now();\n    // 开启动画\n    this._rafId = vglobal.getRequestAnimationFrame()(this._play.bind(this, true));\n  };\n\n  /**\n   * 播放过程\n   */\n  private _play = (isFirstPlay: boolean) => {\n    const now = Date.now();\n\n    // 抵达终点, 延迟一个interval触发end\n    if (this._isReachEnd && now - this._tickTime >= this._interval) {\n      this._isReachEnd = false;\n      this._playEnd();\n      return;\n    }\n    // 未达终点\n\n    // 第一个播放帧, 立即执行\n    if (isFirstPlay && this._activeIndex !== this._dataIndex) {\n      this.dispatchCustomEvent(PlayerEventEnum.change);\n      this._activeIndex = this._dataIndex;\n    }\n    // 中间播放帧, 每一个interval执行一次\n    else if (now - this._tickTime >= this._interval) {\n      this._tickTime = now;\n      this._updateDataIndex(forwardStep(this._direction, this._dataIndex, this._minIndex, this._maxIndex));\n      this._activeIndex = this._dataIndex;\n      this.dispatchCustomEvent(PlayerEventEnum.change);\n    }\n\n    // 终止条件\n    if (\n      (this._direction === 'default' && this._dataIndex >= this._maxIndex) ||\n      (this._direction === 'reverse' && this._dataIndex <= this._minIndex)\n    ) {\n      this._isReachEnd = true;\n    }\n\n    this._rafId = vglobal.getRequestAnimationFrame()(this._play.bind(this, false));\n  };\n\n  /**\n   * 更新数据\n   */\n  private _updateDataIndex = (dataIndex: number) => {\n    this._dataIndex = dataIndex;\n    this._slider.setValue(this._dataIndex);\n  };\n\n  /**\n   * 播放结束\n   */\n  private _playEnd = () => {\n    // 播放状态更新\n    this._isPlaying = false;\n    // 图标切换\n    this._controller.togglePlay();\n    // 取消播放动画\n    vglobal.getCancelAnimationFrame()(this._rafId);\n    // 重置ActiveIndex\n    this._activeIndex = -1;\n    // 播放结束时并且到达终点\n    this.dispatchCustomEvent(PlayerEventEnum.end);\n  };\n\n  /**\n   * 暂停接口\n   */\n  pause = () => {\n    if (!this._isPlaying) {\n      return;\n    }\n    this._isPlaying = false;\n    vglobal.getCancelAnimationFrame()(this._rafId);\n    this._controller.togglePlay();\n\n    this.dispatchCustomEvent(PlayerEventEnum.pause);\n  };\n\n  /**\n   * 后退接口\n   */\n  backward = () => {\n    const index = Math.max(this._dataIndex - 1, this._minIndex);\n    this._updateDataIndex(index);\n\n    this.dispatchCustomEvent(PlayerEventEnum.change);\n    this.dispatchCustomEvent(PlayerEventEnum.backward);\n  };\n\n  /**\n   * 前进接口\n   */\n  forward = () => {\n    const index = Math.min(this._dataIndex + 1, this._maxIndex);\n    this._updateDataIndex(index);\n\n    this.dispatchCustomEvent(PlayerEventEnum.change);\n    this.dispatchCustomEvent(PlayerEventEnum.forward);\n  };\n}\n"]}